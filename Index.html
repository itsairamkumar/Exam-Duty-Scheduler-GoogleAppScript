<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#4361ee">
    <meta name="description" content="Invigilator Duty Management System - Search and manage examination invigilation schedules">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Invigilator Chart">
    <link rel="manifest" href="<?= ScriptApp.getService().getUrl() ?>?page=manifest">
    <link rel="apple-touch-icon" href="<?= ScriptApp.getService().getUrl() ?>?page=icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap&text=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=block" rel="stylesheet">
    
    <!-- Notification scripts -->
    <script>
      // Function to check and request notification permissions
      function requestNotificationPermission() {
        if ('Notification' in window) {
          if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                saveNotificationPreference(true);
                showToast('Notifications enabled!');
                // Immediately check for duties after permission is granted
                setTimeout(checkUpcomingDuties, 500);
              } else {
                // If user denied permission
                showToast('Notifications were not enabled');
              }
            });
          } else if (Notification.permission === 'granted') {
            saveNotificationPreference(true);
            showToast('Notifications enabled!');
            // Immediately check for duties
            setTimeout(checkUpcomingDuties, 500);
          }
        } else {
          showToast('Your browser does not support notifications');
        }
      }
      
      // Save notification preference to localStorage
      function saveNotificationPreference(enabled) {
        localStorage.setItem('notificationsEnabled', enabled ? 'true' : 'false');
      }
      
      // Get notification preference from localStorage
      function getNotificationPreference() {
        return localStorage.getItem('notificationsEnabled') === 'true';
      }
      
      // Show a notification for upcoming duties
      function showNotification(title, message) {
        if (!('Notification' in window)) {
          console.log('This browser does not support notifications');
          return;
        }
        
        if (Notification.permission === 'granted' && getNotificationPreference()) {
          // Prevent duplicate notifications by checking if we've shown this one recently
          const notificationKey = `${title}-${message}`;
          const lastShown = localStorage.getItem(notificationKey);
          const now = new Date().getTime();
          
          // Only show if we haven't shown this notification in the last hour
          if (!lastShown || (now - parseInt(lastShown, 10)) > 3600000) {
            const notification = new Notification(title, {
              body: message,
              icon: 'https://cdn-icons-png.flaticon.com/512/2097/2097068.png',
              badge: 'https://cdn-icons-png.flaticon.com/512/2097/2097068.png',
              timestamp: now,
              requireInteraction: true // Keep notification visible until user interacts with it
            });
            
            notification.onclick = function() {
              window.focus();
              notification.close();
            };
            
            // Store timestamp of this notification
            localStorage.setItem(notificationKey, now.toString());
          }
        }
      }
      
      // Check for upcoming duties and trigger notifications
      function checkUpcomingDuties() {
        if (!getNotificationPreference()) return;
        
        const upcomingDuties = JSON.parse(localStorage.getItem('upcomingDuties') || '[]');
        if (!upcomingDuties.length) return;
        
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        // Format dates for comparison
        const todayStr = formatDateForComparison(today);
        const tomorrowStr = formatDateForComparison(tomorrow);
        
        console.log('Checking for duties. Today:', todayStr, 'Tomorrow:', tomorrowStr);
        
        // Check for today's and tomorrow's duties
        upcomingDuties.forEach(duty => {
          // Ensure the duty date is properly formatted
          if (!duty.date) return;
          
          // Convert to consistent format for comparison
          const dutyDate = duty.date;
          console.log('Checking duty date:', dutyDate);
          
          // Check which slots are active for this duty
          const slots = [];
          if (duty.slot1 === 'x') slots.push('Slot 1 (09:00-10:30)');
          if (duty.slot2 === 'x') slots.push('Slot 2 (11:30-13:00)');
          if (duty.slot3 === 'x') slots.push('Slot 3 (15:30-17:00)');
          if (duty.slot4 === 'x') slots.push('Slot 4 (17:30-19:00)');
          
          const slotInfo = slots.length > 0 ? `Slots: ${slots.join(', ')}` : '';
          
          if (dutyDate === todayStr) {
            console.log('Found duty for today:', duty.program);
            showNotification(
              'Invigilation Duty Today',
              `You have an invigilation duty today for ${duty.program}. ${slotInfo}`
            );
          } else if (dutyDate === tomorrowStr) {
            console.log('Found duty for tomorrow:', duty.program);
            showNotification(
              'Invigilation Duty Tomorrow',
              `You have an invigilation duty tomorrow for ${duty.program}. ${slotInfo}`
            );
          }
        });
      }
      
      // Format date for comparison with duty dates (YYYY-MM-DD)
      function formatDateForComparison(date) {
        if (!date) {
          console.warn('Invalid date provided');
          return '';
        }
        try {
          if (date instanceof Date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
          } else if (typeof date === 'string') {
            // Handle dd-MMM-yyyy format
            const dateParts = date.split('-');
            if (dateParts.length === 3) {
              const monthNamesShort = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
              const day = parseInt(dateParts[0]);
              const month = monthNamesShort.indexOf(dateParts[1].toLowerCase());
              const year = parseInt(dateParts[2]);
              
              if (!isNaN(day) && month !== -1 && !isNaN(year)) {
                const dateObj = new Date(year, month, day);
                return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
              }
            }
            return date; // Return original if parsing fails
          }
          return '';
        } catch (e) {
          console.error('Date formatting error:', e);
          return '';
        }
      }
      
      // Show a toast message
      function showToast(message, type = 'info') {
        // Remove any existing toasts
        const existingToasts = document.querySelectorAll('.toast');
        existingToasts.forEach(toast => {
          toast.classList.remove('show');
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        });
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        // For error and success, add an icon
        if (type === 'error' || type === 'success') {
          const icon = document.createElement('span');
          icon.className = 'material-icons toast-icon';
          icon.textContent = type === 'error' ? 'error' : 'check_circle';
          toast.appendChild(icon);
        }
        
        const messageSpan = document.createElement('span');
        messageSpan.textContent = message;
        toast.appendChild(messageSpan);
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('show');
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }, 5000); // Show for 5 seconds
        }, 100);
      }
      
      // Add CSS for improved toast notifications
      document.addEventListener('DOMContentLoaded', function() {
        const style = document.createElement('style');
        style.textContent = `
          .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #4b5563;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            align-items: center;
            max-width: 90%;
          }
          .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
          }
          .toast-success {
            background-color: #10b981;
          }
          .toast-error {
            background-color: #ef4444;
          }
          .toast-icon {
            margin-right: 8px;
            font-size: 18px;
          }
        `;
        document.head.appendChild(style);
      });
    </script>
    
    <style>
      :root{--primary-color:#4361ee;--primary-light:#7b8cff;--primary-dark:#0039cb;--accent-color:#48bfe3;--text-on-primary:#fff;--text-primary:#212121;--text-secondary:#757575;--background-color:#f9fafc;--card-color:#fff;--border-radius:8px;--shadow:0 1px 3px rgba(0,0,0,.08);--hover-shadow:0 4px 8px rgba(0,0,0,.1)}
      *{box-sizing:border-box;margin:0;padding:0}
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}
      body{font-family:'Roboto',sans-serif;background-color:var(--background-color);color:var(--text-primary);padding:0;margin:0;line-height:1.6}
      .header{background:#4361ee;color:var(--text-on-primary);padding:16px 20px;box-shadow:0 1px 6px rgba(0,0,0,.1);position:relative;overflow:hidden;display:flex;flex-direction:column;min-height:auto}
      .header-content{position:relative;z-index:5;max-width:1400px;width:100%;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
      .header-left{display:flex;align-items:center}
      .header h1{font-weight:500;margin:0;font-size:20px;letter-spacing:.3px}
      .header-subtitle{font-weight:300;margin-top:3px;opacity:.9;font-size:13px;max-width:600px}
      .logo-icon{display:inline-flex;align-items:center;justify-content:center;background-color:rgba(255,255,255,.2);color:#fff;width:34px;height:34px;border-radius:6px;font-size:17px;margin-right:12px;backdrop-filter:blur(3px);vertical-align:middle}
      .content{max-width:1400px;margin:0 auto;padding:16px;position:relative}
      .card{background-color:var(--card-color);border-radius:var(--border-radius);box-shadow:var(--shadow);padding:16px;margin-bottom:15px;transition:box-shadow .3s ease;border:1px solid rgba(0,0,0,.04)}
      .card:hover{box-shadow:var(--hover-shadow)}
      .search-container{display:flex;align-items:center;z-index:10;max-width:450px;width:100%;position:relative}
      .search-wrapper{display:flex;align-items:center;background-color:rgba(255,255,255,.9);border-radius:12px;padding:0;width:100%;box-shadow:0 4px 6px rgba(0,0,0,.1);overflow:hidden;transition:all .3s ease;border:2px solid transparent}
      .search-icon{display:flex;align-items:center;justify-content:center;padding:0 0 0 15px;color:var(--primary-color)}
      .search-icon .material-icons{font-size:20px}
      .search-box{flex:1;padding:12px 16px;border:none;font-size:15px;background-color:transparent;color:var(--text-primary);font-weight:500}
      .search-box::placeholder{color:#94a3b8;font-weight:400}
      .search-box:focus{outline:none}
      .search-button{margin:0;padding:12px 24px;background-color:var(--accent-color);color:var(--text-on-primary);border:none;border-radius:0 12px 12px 0;font-size:15px;font-weight:600;cursor:pointer;transition:background-color .3s ease;height:100%;letter-spacing:0.3px}
      .search-button:hover{background-color:#0891b2}
      .reset-button{margin-left:8px;padding:12px 16px;background-color:#f1f5f9;color:var(--text-secondary);border:none;border-radius:12px;font-size:14px;font-weight:500;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:4px}
      .reset-button:hover{background-color:#e2e8f0;color:var(--text-primary)}
      .reset-button .material-icons{font-size:18px}
      .employee-info{background-color:var(--card-color);border-radius:var(--border-radius);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04);margin:16px auto 24px;transform:translateY(0);transition:all .3s ease;max-width:1200px;overflow:hidden}
      .employee-info.appear{animation:slideDown .4s ease forwards}
      .employee-info .section-title{padding:16px 24px;margin:0;border-bottom:1px solid rgba(0,0,0,0.05);font-weight:600;color:var(--text-primary);letter-spacing:0.2px;background:rgba(99,102,241,0.04);display:flex;align-items:center}
      .employee-info .section-title .title-icon{color:var(--primary-color);margin-right:12px;vertical-align:middle;font-size:20px}
      .employee-info .section-title::after{display:none}
      .section-title{font-size:16px;font-weight:500;color:var(--text-primary);margin-bottom:14px;display:flex;align-items:center;position:relative;transition:all 0.3s ease}
      .section-title:hover .title-icon{transform:scale(1.1);color:var(--primary-color)}
      .section-title::after{content:'';height:1px;background:linear-gradient(to right, rgba(67,97,238,0.2), rgba(240,242,245,0));flex:1;margin-left:12px}
      .section-title .title-icon{font-size:18px;color:var(--primary-color);margin-right:8px;vertical-align:middle;opacity:0.9;transition:transform 0.3s ease}
      .card .section-title{margin-top:0;margin-bottom:16px}
      @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
      .employee-details{display:flex;flex-wrap:wrap;width:100%;background-color:white;margin:0;padding:0}
      .employee-detail-item{display:flex;flex-direction:row;align-items:center;padding:16px 24px;background-color:#fff;transition:background-color .2s ease;border:none;flex:1;min-width:200px}
      .employee-detail-item:last-child{border-right:none}
      .employee-detail-item:hover{background-color:rgba(99,102,241,0.02)}
      .detail-icon{display:flex;align-items:center;justify-content:center;width:32px;height:32px;min-width:32px;border-radius:8px;background-color:rgba(99,102,241,0.1);color:var(--primary-color);margin-right:16px}
      .detail-icon .material-icons{font-size:16px}
      .detail-content{flex:1}
      .detail-label{font-size:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-weight:500}
      .detail-value{font-size:15px;color:var(--text-primary);font-weight:500;word-break:break-word;line-height:1.3}
      .duty-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;border-radius:var(--border-radius);overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.05);background-color:#fff}
      .duty-table th,.duty-table td{border:none;border-bottom:1px solid #eaeaea;padding:10px 8px;text-align:center}
      .duty-table th{background-color:#f8f9fb;font-weight:500;position:sticky;top:0;color:var(--text-primary);font-size:12px;letter-spacing:.3px;text-transform:uppercase;padding:12px 8px;border-bottom:2px solid #eaeaea}
      .duty-table tr:last-child td{border-bottom:none}
      .duty-table tr:nth-child(even){background-color:#fafafa}
      .duty-table tr:hover{background-color:#f1f5ff}
      .slot-x{font-weight:bold;color:var(--primary-color);font-size:16px}
      .slot-empty{color:#999}
      .location{font-size:12px;color:#666}
      #results{overflow-x:auto;margin-top:20px;padding:16px 16px 0;box-shadow:var(--shadow)}
      .total-counts{font-weight:600;background-color:rgba(67,97,238,.05)!important;color:var(--primary-color)}
      .season-total{font-weight:bold;color:var(--accent-color);background-color:rgba(67,97,238,.08)!important}
      .loader{display:inline-block;width:24px;height:24px;border:2px solid rgba(67,97,238,.2);border-radius:50%;border-top-color:var(--primary-color);animation:spin .8s linear infinite}
      @keyframes spin{to{transform:rotate(360deg)}}
      .search-loading{display:flex;align-items:center;gap:8px}
      .header-text{display:flex;flex-direction:column}
      /* Responsive styles */
      @media(max-width:768px){
        .header{padding:12px 15px}
        .header-content{flex-direction:row;align-items:center}
        .search-container{max-width:220px}
        .header h1{font-size:16px}
        .header-subtitle{font-size:11px;margin-top:2px}
        .logo-icon{width:28px;height:28px;font-size:15px;margin-right:10px}
        .search-box{padding:6px 10px;font-size:13px}
        .search-button{padding:0 12px;height:32px;font-size:13px}
        .content{padding:12px}
        .card{padding:10px;margin-bottom:10px}
        .search-wrapper{flex-direction:row;padding:0}
        .search-box{padding:10px 8px}
        .search-button{width:auto;padding:10px 15px;border-radius:0;margin-top:0}
        .search-icon{display:flex;padding:0 8px}
        .employee-details{display:flex;flex-wrap:wrap}
        .employee-detail-item{padding:10px 12px}
        .detail-icon{width:28px;height:28px;min-width:28px;margin-right:10px}
        .detail-icon .material-icons{font-size:14px}
        .detail-label{font-size:9px;margin-bottom:2px}
        .detail-value{font-size:14px}
        .duty-table{display:block;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;margin:0;border-radius:4px}
        .duty-table th,.duty-table td{padding:8px 6px;font-size:11px}
        .duty-table th{padding:8px 6px;font-size:10px}
        .slot-x{font-size:14px}
        .location{font-size:10px}
        .scrollable .swipe-indicator{display:flex}
        .touch-device .employee-detail-item:hover{background-color:#fff}
        .touch-device .employee-detail-item:active{background-color:#f5f7ff}
        .search-button{min-height:44px;display:flex;align-items:center;justify-content:center;border-radius:0 50px 50px 0;margin:0;padding:0 20px}
        .search-icon{min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}
        .duty-table th,.duty-table td{min-height:44px;vertical-align:middle}
        .section-title{font-size:15px;margin-bottom:12px}
        .section-title .title-icon{font-size:16px}
        #results{margin-top:16px;padding:12px 12px 0}
        .reset-button{padding:10px 12px;font-size:13px}
        .reset-button .material-icons{font-size:16px}
        .employee-details{display:flex;flex-wrap:wrap}
        .employee-detail-item{flex:1 0 100%;padding:16px 20px}
        /* Hide print and notification options on mobile */
        .feature-buttons{display:none !important}
      }
      @media(max-width:480px){
        .header{padding:12px 15px!important}
        .header-content{flex-direction:column;align-items:flex-start}
        .search-container{display:flex;flex-direction:column;align-items:stretch;max-width:100%;margin-top:6px;gap:8px}
        .search-wrapper{border-width:1px}
        .search-button{padding:0 15px!important;height:32px;font-size:13px}
        .search-box{padding:8px 6px;font-size:14px;height:32px}
        .search-icon{min-width:32px;min-height:32px}
        .search-box::placeholder{font-size:13px}
        .employee-details{display:flex;flex-direction:column}
        .employee-detail-item{padding:14px 16px;width:100%}
        .detail-value{font-size:14px!important;line-height:1.2}
        .duty-table th,.duty-table td{padding:6px 4px!important;font-size:9px!important}
        .slot-x{font-size:12px!important}
        .location{font-size:8px!important}
        input[type="search"]{-webkit-appearance:none;appearance:none}
        input,select,textarea{font-size:16px!important}
        input[type="search"],button{-webkit-appearance:none;appearance:none;border-radius:0}
        .search-button{border-radius:0 50px 50px 0!important}
        .section-title{font-size:14px;margin-bottom:10px}
        .section-title .title-icon{font-size:15px;margin-right:6px}
        #results{margin-top:14px;padding:10px 10px 0}
        .reset-button{margin-left:0;width:100%;justify-content:center;padding:10px}
      }
      /* Table responsiveness */
      .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch;max-width:100%;border-radius:var(--border-radius);will-change:transform}
      .swipe-indicator{text-align:center;padding:8px;color:var(--text-secondary);font-size:12px;background:#f5f7ff;border-radius:0 0 8px 8px;align-items:center;justify-content:center;margin-top:-1px}
      .swipe-indicator .material-icons{font-size:16px;margin-left:4px;animation:swipeAnim 1.5s ease-in-out infinite;will-change:transform}
      @keyframes swipeAnim{0%{transform:translateX(0)}50%{transform:translateX(5px)}100%{transform:translateX(0)}}
      @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      
      /* Modern Duty Chart Redesign - Updated 2024 */
      :root {
        --primary-color: #6366f1;
        --primary-light: #818cf8;
        --primary-dark: #4338ca;
        --accent-color: #0ea5e9;
        --text-on-primary: #fff;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --background-color: #f8fafc;
        --card-color: #fff;
        --border-radius: 18px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        --slot-bg-primary: #eff6ff;
        --slot-bg-empty: #f1f5f9;
        --location-bg: rgba(241, 245, 249, 0.9);
        --header-bg: #6366f1;
        --header-gradient: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
        --table-header-bg: #f8fafc;
        --slot-assigned: #6366f1;
        --day-count-bg: #f1f5f9;
        --season-total-bg: #e0f2fe;
        --current-day-highlight: #fef9c3;
      }

      /* Table redesign with modern aesthetics */
      #results {
        padding: 0;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        background-color: var(--card-color);
        margin-top: 24px;
        border: 1px solid rgba(0,0,0,0.03);
        transition: all 0.3s ease;
      }

      #results:hover {
        box-shadow: var(--hover-shadow);
      }

      .section-title {
        padding: 20px 24px;
        margin: 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        font-weight: 600;
        color: var(--text-primary);
        letter-spacing: 0.2px;
        background: linear-gradient(to right, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.01));
      }

      .section-title .title-icon {
        color: var(--primary-color);
        margin-right: 12px;
        vertical-align: middle;
        font-size: 20px;
      }

      .duty-table-container {
        padding: 0;
        overflow: hidden;
      }

      .table-responsive {
        border-radius: 0;
        overflow-x: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-light) var(--background-color);
        padding-bottom: 4px;
      }

      .table-responsive::-webkit-scrollbar {
        height: 6px;
      }

      .table-responsive::-webkit-scrollbar-track {
        background: var(--background-color);
      }

      .table-responsive::-webkit-scrollbar-thumb {
        background-color: var(--primary-light);
        border-radius: 6px;
      }

      .duty-table {
        margin: 0;
        width: 100%;
        box-shadow: none;
        border-radius: 0;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: fixed;
      }

      .duty-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .duty-table th {
        background-color: var(--table-header-bg);
        color: var(--text-secondary);
        font-weight: 600;
        padding: 18px 14px;
        font-size: 12px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        vertical-align: middle;
        text-align: center;
        position: relative;
        width: auto;
      }

      .duty-table th:nth-child(1) { width: 8%; }  /* Days */
      .duty-table th:nth-child(2) { width: 10%; } /* Date */
      .duty-table th:nth-child(3) { width: 10%; } /* Week */
      .duty-table th:nth-child(4) { width: 16%; } /* Program */
      .duty-table th:nth-child(5),
      .duty-table th:nth-child(7),
      .duty-table th:nth-child(9),
      .duty-table th:nth-child(11) { width: 5%; } /* Slots */
      .duty-table th:nth-child(6),
      .duty-table th:nth-child(8),
      .duty-table th:nth-child(10),
      .duty-table th:nth-child(12) { width: 8%; } /* Locations */
      .duty-table th:nth-child(13),
      .duty-table th:nth-child(14) { width: 7%; } /* Totals */

      .duty-table th::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 3px;
        background-color: var(--primary-color);
        transition: width 0.2s ease;
      }

      .duty-table th:hover::after {
        width: 40%;
      }

      .duty-table td {
        padding: 16px 12px;
        font-size: 14px;
        border-bottom: 1px solid rgba(0,0,0,0.03);
        vertical-align: middle;
        text-align: center;
        transition: all 0.2s ease;
        height: 76px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .duty-table tr {
        transition: background-color 0.3s ease;
      }

      .duty-table tr:hover {
        background-color: rgba(99, 102, 241, 0.04);
      }

      .duty-table tr.current-day {
        background-color: var(--current-day-highlight);
      }

      .duty-table tr.current-day:hover {
        background-color: rgba(254, 249, 195, 0.8);
      }

      .duty-table tr:last-child td {
        border-bottom: none;
      }

      .slot-bg {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        transition: all 0.3s ease;
        font-size: 16px;
        font-weight: bold;
        margin: 0 auto;
      }

      .slot-x {
        font-weight: 600;
        color: white;
      }

      .slot-x .slot-bg {
        background-color: var(--slot-assigned);
        box-shadow: 0 4px 6px rgba(99, 102, 241, 0.25);
        transform: translateY(0);
      }

      .slot-x:hover .slot-bg {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(99, 102, 241, 0.3);
      }

      .slot-empty .slot-bg {
        background-color: var(--slot-bg-empty);
        color: #cbd5e1;
        border: 1px solid rgba(0,0,0,0.03);
      }

      .slot-empty:hover .slot-bg {
        background-color: #e2e8f0;
        transform: scale(1.05);
      }

      .location {
        font-size: 12px;
        color: var(--text-secondary);
        padding: 4px 10px;
        background: var(--location-bg);
        border-radius: 6px;
        display: inline-block;
        max-width: 130px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border: 1px solid rgba(0,0,0,0.03);
        transition: all 0.3s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      .location:hover {
        background: #e2e8f0;
        color: var(--text-primary);
        transform: translateY(-2px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.08);
      }

      .total-counts {
        background-color: var(--day-count-bg) !important;
        color: var(--text-primary);
        font-weight: 600;
        position: relative;
      }

      .total-counts::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--primary-light);
        opacity: 0.6;
      }

      .season-total {
        background-color: var(--season-total-bg) !important;
        color: var(--primary-dark);
        font-weight: 700;
        position: relative;
      }

      .season-total::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--accent-color);
        opacity: 0.6;
      }

      .swipe-indicator {
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        background: linear-gradient(to right, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.1));
        padding: 12px 16px 16px;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .swipe-text {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .swipe-text .material-icons {
        margin-left: 8px;
        font-size: 18px;
        animation: swipeAnim 1.5s ease-in-out infinite;
      }

      .credits {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--text-secondary);
        opacity: 0.8;
        font-weight: 400;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
        padding-top: 12px;
        width: 100%;
        text-align: center;
      }

      .credit-item {
        display: inline-flex;
        align-items: center;
        transition: color 0.2s ease;
        padding: 4px 0;
      }

      .credit-item:hover {
        color: var(--primary-color);
      }

      .credit-divider {
        font-size: 10px;
        opacity: 0.6;
      }

      /* Mobile optimizations for the duty chart */
      @media(max-width:768px) {
        #results {
          border-radius: 14px;
          margin-top: 16px;
        }
        
        .section-title {
          padding: 16px 18px;
          font-size: 16px;
        }
        
        .section-title .title-icon {
          font-size: 18px;
        }
        
        .duty-table th {
          padding: 14px 8px;
          font-size: 11px;
        }
        
        .duty-table th:nth-child(1) { width: 7%; }  /* Days */
        .duty-table th:nth-child(2) { width: 11%; } /* Date */
        .duty-table th:nth-child(3) { width: 9%; }  /* Week */
        .duty-table th:nth-child(4) { width: 14%; } /* Program */
        .duty-table th:nth-child(5),
        .duty-table th:nth-child(7),
        .duty-table th:nth-child(9),
        .duty-table th:nth-child(11) { width: 5%; } /* Slots */
        .duty-table th:nth-child(6),
        .duty-table th:nth-child(8),
        .duty-table th:nth-child(10),
        .duty-table th:nth-child(12) { width: 8%; } /* Locations */
        .duty-table th:nth-child(13),
        .duty-table th:nth-child(14) { width: 7%; } /* Totals */
        
        .duty-table td {
          padding: 12px 8px;
          font-size: 13px;
          height: 66px;
        }
        
        .slot-bg {
          width: 32px;
          height: 32px;
          font-size: 14px;
        }
        
        .location {
          padding: 3px 8px;
          font-size: 10px;
          max-width: 90px;
        }
        
        .swipe-indicator {
          padding: 10px;
          font-size: 12px;
        }
        
        .credits {
          font-size: 11px;
          gap: 6px;
        }
      }

      @media(max-width:480px) {
        #results {
          border-radius: 12px;
        }
        
        .section-title {
          padding: 14px 16px;
          font-size: 15px;
        }
        
        .section-title .title-icon {
          font-size: 16px;
        }
        
        .duty-table th {
          padding: 12px 6px;
          font-size: 10px;
        }
        
        .duty-table th:nth-child(1) { width: 7%; }  /* Days */
        .duty-table th:nth-child(2) { width: 11%; } /* Date */
        .duty-table th:nth-child(3) { width: 9%; }  /* Week */
        .duty-table th:nth-child(4) { width: 14%; } /* Program */
        .duty-table th:nth-child(5),
        .duty-table th:nth-child(7),
        .duty-table th:nth-child(9),
        .duty-table th:nth-child(11) { width: 4%; } /* Slots */
        .duty-table th:nth-child(6),
        .duty-table th:nth-child(8),
        .duty-table th:nth-child(10),
        .duty-table th:nth-child(12) { width: 7%; } /* Locations */
        .duty-table th:nth-child(13),
        .duty-table th:nth-child(14) { width: 6%; } /* Totals */
        
        .duty-table td {
          padding: 10px 6px;
          font-size: 11px;
          height: 60px;
        }
        
        .slot-bg {
          width: 28px;
          height: 28px;
          font-size: 12px;
        }
        
        .location {
          padding: 2px 6px;
          font-size: 9px;
          max-width: 70px;
        }
        
        .swipe-indicator {
          padding: 8px;
          font-size: 11px;
        }
        
        .credits {
          font-size: 10px;
          gap: 4px;
          flex-direction: column;
        }
        
        .credit-divider {
          display: none;
        }
      }

      /* Modern Header Redesign */
      .header {
        background: var(--header-gradient);
        color: var(--text-on-primary);
        padding: 20px 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: auto;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        pointer-events: none;
      }

      .header-content {
        position: relative;
        z-index: 5;
        max-width: 1400px;
        width: 100%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      .header h1 {
        font-weight: 600;
        margin: 0;
        font-size: 22px;
        letter-spacing: 0.5px;
      }

      .header-subtitle {
        font-weight: 400;
        margin-top: 4px;
        opacity: 0.9;
        font-size: 14px;
        max-width: 600px;
      }

      .logo-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255, 255, 255, 0.2);
        color: #fff;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        font-size: 20px;
        margin-right: 16px;
        backdrop-filter: blur(3px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        vertical-align: middle;
        transition: all 0.3s ease;
      }

      .logo-icon:hover {
        transform: translateY(-2px);
        background-color: rgba(255, 255, 255, 0.25);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      /* Additional styling for date and program cells */
      .date-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        line-height: 1.4;
      }
      
      .date-day {
        font-weight: 600;
        font-size: 16px;
        color: var(--text-primary);
        margin-bottom: 2px;
      }
      
      .date-year {
        font-size: 12px;
        color: var(--text-secondary);
        opacity: 0.8;
      }
      
      .program-cell {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        height: auto;
      }
      
      @media(max-width:768px) {
        .date-day {
          font-size: 14px;
        }
        
        .date-year {
          font-size: 11px;
        }
      }
      
      @media(max-width:480px) {
        .date-day {
          font-size: 13px;
        }
        
        .date-year {
          font-size: 10px;
        }
      }

      /* Mobile optimizations for employee details */
      @media(max-width:1024px) {
        .employee-details {
          display: flex;
          flex-wrap: wrap;
        }
        
        .employee-detail-item {
          flex: 1 0 45%;
          min-width: 200px;
        }
      }

      @media(max-width:768px) {
        .employee-details {
          display: flex;
          flex-wrap: wrap;
        }
        
        .employee-detail-item {
          flex: 1 0 100%;
          padding: 16px 20px;
        }
        
        .detail-icon {
          width: 28px;
          height: 28px;
          min-width: 28px;
          margin-right: 12px;
        }
        
        .detail-icon .material-icons {
          font-size: 14px;
        }
        
        .detail-label {
          font-size: 11px;
          margin-bottom: 4px;
        }
        
        .detail-value {
          font-size: 14px;
        }
        
        .reset-button {
          padding: 10px 12px;
          font-size: 13px;
        }
        
        .reset-button .material-icons {
          font-size: 16px;
        }
      }

      @media(max-width:480px) {
        .employee-details {
          display: flex;
          flex-direction: column;
        }
        
        .employee-detail-item {
          padding: 14px 16px;
          width: 100%;
        }
        
        .employee-detail-item:last-child {
          border-bottom: none;
        }
        
        .detail-icon {
          width: 24px;
          height: 24px;
          min-width: 24px;
          margin-right: 10px;
        }
        
        .detail-label {
          font-size: 10px;
        }
        
        .detail-value {
          font-size: 13px;
        }
        
        .search-container {
          display: flex;
          flex-direction: column;
          align-items: stretch;
          max-width: 100%;
          margin-top: 6px;
          gap: 8px;
        }
        
        .reset-button {
          margin-left: 0;
          width: 100%;
          justify-content: center;
          padding: 10px;
        }
      }

      /* Safe area insets for notched phones */
      @supports (padding: max(0px)) {
        .header {
          padding-left: max(20px, env(safe-area-inset-left));
          padding-right: max(20px, env(safe-area-inset-right));
          padding-top: max(20px, env(safe-area-inset-top));
        }
        .content {
          padding-left: max(16px, env(safe-area-inset-left));
          padding-right: max(16px, env(safe-area-inset-right));
          padding-bottom: max(16px, env(safe-area-inset-bottom));
        }
      }
      
      /* Enhanced touch targets for mobile */
      @media (pointer: coarse) {
        button, 
        input, 
        .search-button, 
        .reset-button,
        .search-box,
        .search-icon {
          min-height: 44px;
        }
        
        .slot-bg {
          min-width: 36px;
          min-height: 36px;
        }
      }

      /* Improved mobile form interactions */
      @media (max-width: 768px) {
        input[type="search"] {
          font-size: 16px !important; /* Prevents zoom on focus in iOS */
        }
        
        .search-wrapper {
          border-radius: 16px;
          flex-direction: row;
          align-items: center;
        }
        
        .search-container {
          max-width: 100%;
        }
      }
      
      /* Optimized for very small screens */
      @media (max-width: 360px) {
        .header h1 {
          font-size: 15px;
        }
        
        .header-subtitle {
          font-size: 10px;
        }
        
        .slot-bg {
          width: 24px;
          height: 24px;
          font-size: 11px;
        }
        
        .duty-table th {
          padding: 10px 4px;
          font-size: 9px;
        }
        
        .duty-table td {
          padding: 8px 4px;
          font-size: 10px;
          height: 54px;
        }
        
        .location {
          padding: 2px 4px;
          font-size: 8px;
          max-width: 60px;
        }
      }
      
      /* Optimized table for landscape orientation on mobile */
      @media (max-height: 500px) and (orientation: landscape) {
        .header {
          padding: 10px 15px;
        }
        
        .header-content {
          flex-direction: row;
          align-items: center;
        }
        
        .logo-icon {
          width: 26px;
          height: 26px;
          font-size: 13px;
          margin-right: 8px;
        }
        
        .header h1 {
          font-size: 15px;
        }
        
        .header-subtitle {
          font-size: 10px;
        }
        
        .employee-detail-item {
          padding: 10px;
        }
        
        .duty-table td {
          height: 48px;
          padding: 6px 4px;
        }
        
        .slot-bg {
          width: 26px;
          height: 26px;
          font-size: 11px;
        }
      }
      
      /* Improve scrolling performance */
      .table-responsive {
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
        overscroll-behavior-x: contain;
        scroll-snap-type: x proximity;
      }
      
      /* PWA support */
      @media (display-mode: standalone) {
        .header {
          padding-top: env(safe-area-inset-top);
        }
        
        body {
          overscroll-behavior: none; /* Prevents pull-to-refresh */
        }
      }
      
      /* Prefers reduced motion */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          scroll-behavior: auto !important;
        }
      }
      
      /* Toast Notifications */
      .toast {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        transition: bottom 0.3s ease;
        font-weight: 500;
      }
      
      .toast.show {
        bottom: 30px;
      }
      
      /* Feature buttons */
      .feature-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 16px;
      }
      
      .feature-button {
        display: flex;
        align-items: center;
        background-color: white;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      
      .feature-button:hover {
        background-color: #f5f7ff;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        transform: translateY(-2px);
      }
      
      .feature-button .material-icons {
        font-size: 18px;
        margin-right: 8px;
      }
      
      .notification-toggle {
        position: relative;
        display: inline-block;
        width: 42px;
        height: 22px;
        margin-left: 8px;
      }
      
      .notification-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }
      
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      
      input:checked + .toggle-slider {
        background-color: var(--primary-color);
      }
      
      input:checked + .toggle-slider:before {
        transform: translateX(20px);
      }
      
      /* Print-friendly styles */
      @media print {
        body {
          background-color: white;
          color: black;
          font-size: 11pt;
          padding: 0;
          margin: 0;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        
        .header, .search-container, .feature-buttons, .swipe-indicator, .toast {
          display: none !important;
        }
        
        .content {
          padding: 0;
          max-width: 100%;
        }
        
        /* Print header with title */
        .content::before {
          content: "Invigilator Duty Chart";
          display: block;
          text-align: center;
          font-size: 18pt;
          font-weight: bold;
          margin: 0 0 10pt;
          padding: 0 0 5pt;
          color: #1e3a8a;
          border-bottom: none;
          letter-spacing: 0.5pt;
        }
        
        #employeeInfo {
          display: block !important;
          box-shadow: none;
          border: none;
          break-inside: avoid;
          page-break-inside: avoid;
          margin-bottom: 15pt;
          background-color: #f8fafc !important;
          border-radius: 6pt;
          position: relative;
          padding-bottom: 8pt;
        }
        
        #employeeInfo::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 5pt;
          background: linear-gradient(to right, #6366f1, #818cf8) !important;
          border-radius: 6pt 6pt 0 0;
        }
        
        .employee-info .section-title {
          background: none !important;
          font-size: 12pt;
          font-weight: bold;
          padding: 12pt 12pt 8pt;
          border-bottom: none;
          margin: 0;
          color: #4338ca !important;
          display: flex;
          align-items: center;
        }
        
        .employee-details {
          display: flex;
          flex-wrap: wrap;
          page-break-inside: avoid;
          padding: 0 6pt;
          background-color: white !important;
          border-radius: 4pt;
          margin: 0 8pt;
          box-shadow: 0 1pt 3pt rgba(0,0,0,0.05) !important;
        }
        
        .employee-detail-item {
          flex: 1 0 45%;
          padding: 10pt;
          border: none;
          page-break-inside: avoid;
          position: relative;
          display: flex;
          flex-direction: row;
          align-items: center;
          min-height: 32pt;
        }
        
        .employee-detail-item::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 10pt;
          right: 10pt;
          height: 1pt;
          background-color: #f1f5f9;
        }
        
        .detail-icon {
          display: flex !important;
          align-items: center;
          justify-content: center;
          width: 24pt;
          height: 24pt;
          min-width: 24pt;
          background-color: #eff6ff !important;
          color: #3b82f6 !important;
          border-radius: 50%;
          margin-right: 10pt;
        }
        
        .detail-icon .material-icons {
          font-size: 12pt;
          color: #3b82f6 !important;
        }
        
        .detail-label {
          font-size: 7pt;
          margin-bottom: 3pt;
          color: #64748b !important;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.5pt;
        }
        
        .detail-value {
          font-size: 10pt;
          font-weight: 600;
          color: #0f172a !important;
        }
        
        #results {
          display: block !important;
          box-shadow: none;
          border: none;
          margin-top: 15pt;
          page-break-before: auto;
          background-color: #f8fafc !important;
          border-radius: 6pt;
          position: relative;
          padding-bottom: 12pt;
          overflow: hidden;
        }
        
        #results::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 5pt;
          background: linear-gradient(to right, #3b82f6, #60a5fa) !important;
          border-radius: 6pt 6pt 0 0;
        }
        
        .section-title {
          background: none !important;
          font-size: 12pt;
          font-weight: bold;
          padding: 12pt 12pt 8pt;
          border-bottom: none;
          margin: 0;
          color: #1e40af !important;
          display: flex;
          align-items: center;
        }
        
        .section-title .title-icon {
          display: none;
        }
        
        .duty-table-container {
          margin: 0 8pt;
          background-color: white !important;
          border-radius: 4pt;
          box-shadow: 0 1pt 3pt rgba(0,0,0,0.05) !important;
          overflow: hidden;
        }
        
        .duty-table {
          width: 100% !important;
          border-collapse: collapse;
          box-shadow: none;
          font-size: 8pt;
          table-layout: fixed;
          page-break-inside: auto;
          margin: 0;
        }
        
        .duty-table th {
          background-color: #f1f5f9 !important;
          color: #475569 !important;
          font-weight: 600;
          border: none;
          border-bottom: 1pt solid #e2e8f0;
          padding: 8pt 4pt;
          font-size: 7pt;
          text-transform: uppercase;
          vertical-align: middle;
          height: auto;
          letter-spacing: 0.3pt;
        }
        
        .duty-table td {
          border: none;
          border-bottom: 0.5pt solid #f1f5f9;
          padding: 6pt 3pt;
          height: auto;
          font-size: 8pt;
          vertical-align: middle;
        }
        
        .duty-table tr {
          page-break-inside: avoid;
        }
        
        .duty-table tr:nth-child(even) {
          background-color: #f8fafc !important;
        }
        
        .duty-table tr.current-day {
          background-color: #fef9c3 !important;
        }
        
        .duty-table tr:last-child td {
          border-bottom: none;
        }
        
        .duty-table td, .duty-table th {
          text-align: center;
          vertical-align: middle;
        }
        
        /* Optimize column widths for print */
        .duty-table th:nth-child(1) { width: 5%; }  /* Days */
        .duty-table th:nth-child(2) { width: 8%; }  /* Date */
        .duty-table th:nth-child(3) { width: 6%; }  /* Week */
        .duty-table th:nth-child(4) { width: 18%; } /* Program */
        
        /* Slots */
        .duty-table th:nth-child(5),
        .duty-table th:nth-child(7),
        .duty-table th:nth-child(9),
        .duty-table th:nth-child(11) { width: 4%; }
        
        /* Locations */
        .duty-table th:nth-child(6),
        .duty-table th:nth-child(8),
        .duty-table th:nth-child(10),
        .duty-table th:nth-child(12) { width: 7%; }
        
        /* Totals */
        .duty-table th:nth-child(13),
        .duty-table th:nth-child(14) { width: 5%; }
        
        .slot-bg {
          width: 16pt;
          height: 16pt;
          font-size: 9pt;
          border-radius: 50%;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto;
        }
        
        .slot-x .slot-bg {
          background-color: #6366f1 !important;
          color: white !important;
          font-weight: bold;
          border: none;
          box-shadow: 0 1pt 2pt rgba(99, 102, 241, 0.3) !important;
        }
        
        .slot-empty .slot-bg {
          background-color: #f8fafc !important;
          color: #cbd5e1 !important;
          border: 0.75pt solid #e2e8f0;
        }
        
        .location {
          font-size: 6pt;
          padding: 1pt 3pt;
          background: #f8fafc !important;
          border: 0.5pt solid #e2e8f0;
          max-width: none;
          display: inline-block;
          border-radius: 3pt;
          color: #64748b !important;
        }
        
        .date-cell {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
        }
        
        .date-day {
          font-size: 8pt;
          font-weight: bold;
          color: #0f172a !important;
        }
        
        .date-year {
          font-size: 6pt;
          color: #64748b !important;
        }
        
        .program-cell {
          font-size: 7.5pt;
          line-height: 1.2;
          color: #334155 !important;
          padding: 0 2pt;
        }
        
        .total-counts {
          font-weight: bold;
          background-color: #f1f5f9 !important;
          color: #0f172a !important;
          position: relative;
        }
        
        .total-counts::before {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 2pt;
          background-color: #818cf8 !important;
        }
        
        .season-total {
          font-weight: bold;
          background-color: #dbeafe !important;
          color: #1e40af !important;
          position: relative;
        }
        
        .season-total::before {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 2pt;
          background-color: #3b82f6 !important;
        }
        
        .table-responsive {
          overflow: visible;
        }
        
        .duty-table-container {
          overflow: visible;
        }
        
        /* Add print footer with page numbers */
        @page {
          size: landscape;
          margin: 0.75cm;
          counter-increment: page;
        }
        
        @page :first {
          margin-top: 1cm;
        }
        
        /* Footer with page numbers, timestamp and credits */
        .content::after {
          content: " Printed on " attr(data-print-date);
          display: block;
          text-align: center;
          font-size: 7pt;
          color: #64748b;
          margin-top: 20pt;
          position: fixed;
          bottom: 0.8cm;
          left: 0;
          right: 0;
        }
        
        /* Add credits line as a separate footer element */
        #results::after {
          content: "💡 Concept by Dr. Sahel Md Delabul Hossain • © by Sairam";
          display: block;
          text-align: center;
          font-size: 7.5pt;
          color: #64748b;
          font-weight: 500;
          margin-top: 15pt;
          padding-top: 8pt;
          border-top: 0.5pt solid #e2e8f0;
          page-break-inside: avoid;
          page-break-before: avoid;
          margin-bottom: 25pt;
        }
      }

      /* Duty Swap Features - New Addition */
      .swap-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: #f97316;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        padding: 2px 6px;
        margin-top: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0.9;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        min-width: 48px; /* Add minimum width to prevent text cutoff */
        white-space: nowrap; /* Prevent text wrapping */
        overflow: visible; /* Ensure content isn't cut off */
      }

      .swap-button:hover {
        background-color: #ea580c;
        opacity: 1;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      }

      .swap-button .material-icons {
        font-size: 12px;
        margin-right: 3px;
      }

      .swap-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .swap-modal.active {
        display: flex;
        opacity: 1;
      }
      
      .swap-modal-content {
        background-color: white;
        border-radius: 8px;
        width: 95%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(20px);
        transition: transform 0.3s ease;
      }
      
      .swap-modal.active .swap-modal-content {
        transform: translateY(0);
      }
      
      .swap-close-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }
      
      .swap-close-button:hover {
        color: #333;
      }
      
      .swap-requests-list {
        max-height: 500px;
        overflow-y: auto;
        margin-top: 10px;
      }
      
      .swap-requests-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      
      .swap-requests-header h3 {
        margin: 0;
        font-size: 18px;
        color: var(--text-primary);
      }
      
      .refresh-button {
        display: flex;
        align-items: center;
        gap: 4px;
        background-color: var(--light-bg);
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        color: var(--text-primary);
        transition: all 0.2s;
      }
      
      .refresh-button:hover {
        background-color: var(--primary-light);
        border-color: var(--primary);
        color: var(--primary);
      }
      
      .refresh-button .material-icons {
        font-size: 16px;
      }
      
      .swap-request-item {
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
      }
      
      .swap-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e2e8f0;
      }

      .swap-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
      }

      .swap-modal-title .material-icons {
        margin-right: 8px;
        color: #f97316;
      }

      .swap-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #64748b;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .swap-modal-close:hover {
        background-color: #f1f5f9;
        color: #0f172a;
      }

      .swap-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .swap-form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .swap-form-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .swap-form-input {
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .swap-form-input:focus {
        outline: none;
        border-color: #f97316;
        box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2);
      }

      .swap-form-message {
        resize: vertical;
        min-height: 80px;
      }

      .swap-form-help {
        font-size: 12px;
        color: #64748b;
        margin-top: 4px;
      }

      .swap-form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 8px;
      }

      .swap-form-button {
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .swap-form-cancel {
        background-color: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
      }

      .swap-form-cancel:hover {
        background-color: #e2e8f0;
        color: #0f172a;
      }

      .swap-form-submit {
        background-color: #f97316;
        color: white;
        border: none;
      }

      .swap-form-submit:hover {
        background-color: #ea580c;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .duty-requests-button {
        display: none; /* Hide the duty requests button completely */
      }
      
      .admin-button {
        background-color: #6366f1;
        color: white;
        border: none;
      }
      
      .admin-button:hover {
        background-color: #4f46e5;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        transform: translateY(-2px);
      }
      
      .admin-button .material-icons {
        color: white;
      }
      
      /* Mobile responsiveness for swap features */
      @media(max-width:768px) {
        .swap-button {
          font-size: 10px;
          padding: 2px 6px; /* Increased horizontal padding */
          min-width: 32px; /* Minimum width for mobile */
          overflow: visible;
        }
        
        .swap-button .material-icons {
          font-size: 10px;
          margin-right: 3px;
        }
        
        .swap-modal-content {
          width: 95%;
          padding: 16px;
        }
        
        .swap-modal-title {
          font-size: 16px;
        }
      }
      
      @media(max-width:480px) {
        .swap-form-actions {
          flex-direction: column;
          gap: 8px;
        }
        
        .swap-form-button {
          width: 100%;
          padding: 12px 16px;
        }
      }
      
      /* Swap Request List Styles */
      .swap-requests-list {
        display: none; /* Hide the list initially */
        flex-direction: column;
        gap: 16px;
        max-height: 60vh;
        overflow-y: auto;
        padding: 4px;
      }
      
      .swap-request-item {
        display: none; /* Hide individual items initially */
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        border-left: 4px solid #cbd5e1;
      }
      
      .swap-request-item.request-pending {
        display: none; /* Hide pending items */
        border-left-color: #f97316;
      }
      
      .swap-request-item.request-approved {
        display: none; /* Hide approved items */
        border-left-color: #22c55e;
      }
      
      .swap-request-item.request-rejected {
        display: none; /* Hide rejected items */
        border-left-color: #ef4444;
      }
      
      .request-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }
      
      .request-title {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-primary);
      }
      
      .request-status {
        font-size: 12px;
        font-weight: 500;
        padding: 4px 10px;
        border-radius: 12px;
        background-color: #e2e8f0;
        color: #64748b;
      }
      
      .request-pending .request-status {
        background-color: #ffedd5;
        color: #c2410c;
      }
      
      .request-approved .request-status {
        background-color: #dcfce7;
        color: #15803d;
      }
      
      .request-rejected .request-status {
        background-color: #fee2e2;
        color: #b91c1c;
      }
      
      .request-body {
        padding: 16px;
        font-size: 14px;
        color: var(--text-primary);
      }
      
      .request-body p {
        margin: 8px 0;
        line-height: 1.4;
      }
      
      .request-body strong {
        font-weight: 600;
        color: #334155;
      }
      
      .request-time {
        font-size: 12px;
        color: #64748b;
        font-style: italic;
        margin-top: 12px !important;
      }
      
      .request-actions {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        background-color: #f8fafc;
        border-top: 1px solid #e2e8f0;
        justify-content: flex-end;
      }
      
      .request-action {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .approve-btn {
        background-color: #22c55e;
        color: white;
        border: none;
      }
      
      .approve-btn:hover {
        background-color: #16a34a;
        transform: translateY(-1px);
      }
      
      .reject-btn {
        background-color: #ef4444;
        color: white;
        border: none;
      }
      
      .reject-btn:hover {
        background-color: #dc2626;
        transform: translateY(-1px);
      }
      
      .delete-btn {
        background-color: transparent;
        color: #64748b;
        border: 1px solid #cbd5e1;
      }
      
      .delete-btn:hover {
        background-color: #f1f5f9;
        color: #1e293b;
      }
      
      .swap-details {
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 16px;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 8px;
      }
      
      .swap-details p {
        margin: 6px 0;
      }
      
      .swap-details strong {
        font-weight: 600;
        color: #334155;
      }
      
      /* Mobile Responsive Swap Request List */
      @media(max-width:768px) {
        .swap-requests-list {
          max-height: 70vh;
        }
        
        .request-actions {
          flex-wrap: wrap;
        }
        
        .request-action {
          flex: 1;
          text-align: center;
          font-size: 12px;
          padding: 8px;
        }
      }
      
      @media(max-width:480px) {
        .swap-requests-list {
          gap: 12px;
        }
        
        .request-header {
          padding: 10px 12px;
        }
        
        .request-title {
          font-size: 14px;
        }
        
        .request-status {
          font-size: 11px;
          padding: 3px 8px;
        }
        
        .request-body {
          padding: 12px;
          font-size: 13px;
        }
        
        .request-actions {
          padding: 10px 12px;
        }
      }

      .location {
        font-size: 12px;
        color: var(--text-secondary);
        padding: 4px 10px;
        background: var(--location-bg);
        border-radius: 6px;
        display: inline-block;
        max-width: 130px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border: 1px solid rgba(0,0,0,0.03);
        transition: all 0.3s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      .location:hover {
        background: #e2e8f0;
        color: var(--text-primary);
        transform: translateY(-2px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.08);
      }

      .total-counts {
        background-color: var(--day-count-bg) !important;
        color: var(--text-primary);
        font-weight: 600;
        position: relative;
      }

      .total-counts::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--primary-light);
        opacity: 0.6;
      }

      .season-total {
        background-color: var(--season-total-bg) !important;
        color: var(--primary-dark);
        font-weight: 700;
        position: relative;
      }

      .season-total::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--accent-color);
        opacity: 0.6;
      }

      /* Table responsive improvements */
      .duty-table {
        table-layout: fixed;
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      .duty-table th {
        text-align: center;
        vertical-align: middle;
        padding: 8px 6px;
        white-space: normal;
        overflow-wrap: break-word;
        word-wrap: break-word;
        font-weight: 600;
      }
      
      .location-cell {
        text-align: center;
        min-width: 80px;
        white-space: normal;
        overflow-wrap: break-word;
        word-wrap: break-word;
      }
      
      .location {
        white-space: normal;
        overflow-wrap: break-word;
        word-wrap: break-word;
        display: block;
        width: 100%;
      }
      
      /* Adjust column widths */
      .duty-table th:nth-child(1) { width: 8%; }  /* Date */
      .duty-table th:nth-child(2) { width: 7%; }  /* Week */
      .duty-table th:nth-child(3) { width: 15%; } /* Program */
      .duty-table th:nth-child(4), 
      .duty-table th:nth-child(6),
      .duty-table th:nth-child(8),
      .duty-table th:nth-child(10) { width: 7%; } /* Slots */
      .duty-table th:nth-child(5), 
      .duty-table th:nth-child(7),
      .duty-table th:nth-child(9),
      .duty-table th:nth-child(11) { width: 9%; } /* Locations */
      .duty-table th:nth-child(12) { width: 6%; } /* Day Total */
      .duty-table th:nth-child(13) { width: 6%; } /* Season Total */

      /* Additional responsive table improvements */
      @media (max-width: 1024px) {
        .table-responsive {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          width: 100%;
        }
        
        .duty-table th {
          padding: 8px 4px;
        }
      }
      
      @media (max-width: 768px) {
        .duty-table {
          min-width: 920px; /* Ensure minimum width for smaller screens */
        }
        
        .location-cell {
          min-width: 70px;
        }
        
        /* Adjust column widths for mobile */
        .duty-table th:nth-child(1) { width: 9%; }  /* Date */
        .duty-table th:nth-child(2) { width: 8%; }  /* Week */
        .duty-table th:nth-child(3) { width: 14%; } /* Program */
        .duty-table th:nth-child(4), 
        .duty-table th:nth-child(6),
        .duty-table th:nth-child(8),
        .duty-table th:nth-child(10) { width: 6%; } /* Slots */
        .duty-table th:nth-child(5), 
        .duty-table th:nth-child(7),
        .duty-table th:nth-child(9),
        .duty-table th:nth-child(11) { width: 8%; } /* Locations */
      }
      
      .program-cell {
        word-break: break-word;
        white-space: normal;
        max-width: 100%;
      }

      /* Improve slot and location cell rendering */
      .slot-x, .slot-empty {
        text-align: center;
        padding: 6px 4px;
      }
      
      .slot-bg {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }
      
      .location-cell {
        text-align: center;
        padding: 4px;
        font-size: 13px;
        line-height: 1.3;
      }
      
      .location {
        display: block;
        word-break: normal;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
      }
      
      /* Ensure table is fully responsive */
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
      }

      /* Additional Mobile Responsiveness Styles */
      @media (max-width: 768px) {
        .swap-modal-content {
          width: 95%;
          padding: 16px;
          max-height: 90vh;
          overflow-y: auto;
        }
        
        .swap-detail-grid {
          grid-template-columns: 1fr;
        }
        
        .swap-form-actions {
          flex-direction: column;
          gap: 8px;
        }
        
        .swap-form-actions button {
          width: 100%;
        }
      }
      
      @media (max-width: 480px) {
        .swap-modal-title {
          font-size: 16px;
        }
        
        .swap-detail-section {
          padding: 12px;
        }
        
        .swap-detail-title {
          font-size: 14px;
        }
        
        .swap-form {
          gap: 12px;
        }
      }
      
      /* Styles for swap modal components */
      .swap-detail-section {
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .swap-detail-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-top: 0;
        margin-bottom: 12px;
      }
      
      .swap-detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      .swap-detail-item {
        display: flex;
        flex-direction: column;
      }
      
      .swap-detail-label {
        font-size: 12px;
        color: #64748b;
        margin-bottom: 4px;
      }
      
      .swap-detail-value {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }
      
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }
      
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }
      
      .swap-form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
      }
      
      .swap-form-cancel {
        padding: 10px 16px;
        background-color: #f1f5f9;
        color: #334155;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      
      .swap-form-cancel:hover {
        background-color: #e2e8f0;
      }
      
      .swap-form-submit {
        padding: 10px 16px;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      
      .swap-form-submit:hover {
        background-color: #2563eb;
      }
      
      /* Improved Mobile Responsiveness */
      @media (max-width: 768px) {
        .swap-modal-content {
          width: 95%;
          padding: 16px;
          max-height: 90vh;
          overflow-y: auto;
        }
        
        .swap-detail-grid {
          grid-template-columns: 1fr;
        }
        
        .swap-form-actions {
          flex-direction: column;
          gap: 8px;
        }
        
        .swap-form-actions button {
          width: 100%;
        }
        
        /* Header responsiveness */
        .header {
          padding: 12px 16px;
        }
        
        .search-container {
          max-width: 100%;
        }
        
        /* Better table responsiveness */
        .duty-table {
          font-size: 13px;
        }
        
        .duty-table th, 
        .duty-table td {
          padding: 8px 4px;
        }
        
        /* Action buttons on mobile */
        .action-buttons {
          flex-direction: column;
          gap: 8px;
          align-items: stretch;
        }
        
        .action-buttons button {
          width: 100%;
        }
        
        /* Card layout for content */
        .card {
          padding: 16px;
          margin-bottom: 16px;
        }
      }
      
      @media (max-width: 480px) {
        /* Further adjustments for very small screens */
        .swap-modal-title {
          font-size: 16px;
        }
        
        .swap-detail-section {
          padding: 12px;
        }
        
        .swap-detail-title {
          font-size: 14px;
        }
        
        .swap-form {
          gap: 12px;
        }
        
        .duty-table {
          font-size: 12px;
        }
        
        /* Compact header */
        .header-title {
          font-size: 18px;
        }
        
        /* Stack filter and action elements */
        .filters-container {
          flex-direction: column;
          align-items: stretch;
        }
        
        .filters-group {
          margin-bottom: 8px;
        }
        
        /* Adjust calendar/date display */
        .calendar-header {
          flex-direction: column;
          gap: 8px;
        }
        
        /* General spacing adjustments */
        .container {
          padding: 12px 8px;
        }
        
        /* Improve tap targets */
        button, 
        select, 
        .search-button {
          min-height: 44px;
        }
      }
      
      /* Fix for landscape orientation on small devices */
      @media (max-height: 500px) and (orientation: landscape) {
        .swap-modal-content {
          max-height: 95vh;
          overflow-y: auto;
        }
        
        .header {
          padding: 8px 12px;
        }
        
        .container {
          padding-top: 8px;
        }
      }

      .swap-modal-content {
        background-color: white;
        margin: 60px auto;
        padding: 24px;
        width: 90%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        position: relative;
      }
      
      .swap-modal-header {
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .swap-modal-title {
        font-size: 18px;
        font-weight: 500;
        color: #1e293b;
      }
      
      .swap-modal-close {
        background: none;
        border: none;
        color: #64748b;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      
      .swap-modal-close:hover {
        background-color: #f1f5f9;
        color: #0f172a;
      }
      
      .swap-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .form-label {
        font-size: 14px;
        font-weight: 500;
        color: #334155;
      }
      
      .form-input {
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 14px;
        color: #0f172a;
        transition: border-color 0.2s ease;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
      }
      
      .form-select {
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 14px;
        color: #0f172a;
        background-color: white;
        transition: border-color 0.2s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        padding-right: 40px;
      }
      
      .form-select:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
      }
      
      .form-textarea {
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 14px;
        color: #0f172a;
        transition: border-color 0.2s ease;
        min-height: 80px;
        resize: vertical;
      }
      
      .form-textarea:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
      }
      
      .swap-form-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 12px;
      }
      
      .swap-form-button {
        padding: 10px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .swap-form-button-cancel {
        background-color: #f1f5f9;
        color: #334155;
        border: 1px solid #cbd5e1;
      }
      
      .swap-form-button-cancel:hover {
        background-color: #e2e8f0;
      }
      
      .swap-form-button-submit {
        background-color: #4361ee;
        color: white;
        border: none;
      }
      
      .swap-form-button-submit:hover {
        background-color: #3a56d4;
      }
      
      .swap-form-button-submit:disabled {
        background-color: #cbd5e1;
        cursor: not-allowed;
      }
      
      /* Swap status badge */
      .swap-status {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .swap-status-pending {
        background-color: #fef9c3;
        color: #854d0e;
      }
      
      .swap-status-approved {
        background-color: #dcfce7;
        color: #166534;
      }
      
      .swap-status-rejected {
        background-color: #fee2e2;
        color: #991b1b;
      }
      
      /* Swap requests list */
      .swap-requests-container {
        margin-top: 24px;
      }
      
      .swap-requests-title {
        font-size: 16px;
        font-weight: 500;
        color: #334155;
        margin-bottom: 12px;
      }
      
      .swap-requests-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .swap-request-card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 14px;
        border-left: 3px solid #94a3b8;
      }
      
      .swap-request-card.pending {
        border-left-color: #facc15;
      }
      
      .swap-request-card.approved {
        border-left-color: #10b981;
      }
      
      .swap-request-card.rejected {
        border-left-color: #ef4444;
      }
      
      .swap-request-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }
      
      .swap-request-details {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 13px;
        color: #475569;
      }
      
      .swap-request-detail {
        display: flex;
        gap: 6px;
      }
      
      .swap-request-label {
        font-weight: 500;
        color: #64748b;
      }
      
      .swap-request-value {
        color: #334155;
      }
      
      .swap-request-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 10px;
      }
      
      .swap-request-button {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .swap-request-button-cancel {
        background-color: #f1f5f9;
        color: #334155;
        border: 1px solid #cbd5e1;
      }
      
      .swap-request-button-cancel:hover {
        background-color: #e2e8f0;
      }
      
      /* Empty state for swap requests */
      .swap-requests-empty {
        padding: 32px 24px;
        text-align: center;
        border: 1px dashed #cbd5e1;
        border-radius: 8px;
        color: #64748b;
      }
      
      .swap-requests-empty-icon {
        font-size: 32px;
        margin-bottom: 12px;
        color: #94a3b8;
      }
      
      .swap-requests-empty-text {
        font-size: 14px;
        line-height: 1.5;
      }

      .swap-requests-button {
        position: relative;
      }

      .swap-requests-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #e63946;
        color: white;
        font-size: 12px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      /* Swap Requests Modal Styles */
      .swap-requests-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .swap-requests-modal.active {
        display: block;
        opacity: 1;
      }

      .swap-requests-modal .modal-content {
        background-color: var(--surface-color);
        margin: 5% auto;
        padding: 0;
        width: 90%;
        max-width: 800px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        animation: modalSlideIn 0.3s ease;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
      }

      .swap-requests-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
        background-color: var(--primary-color);
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        color: white;
      }

      .swap-requests-modal .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 500;
      }

      .swap-requests-modal .close-modal {
        color: white;
        font-size: 1.75rem;
        font-weight: 700;
        cursor: pointer;
        transition: color 0.2s;
      }

      .swap-requests-modal .close-modal:hover {
        color: var(--error-color);
      }

      .swap-requests-modal .modal-body {
        padding: var(--spacing-lg);
        overflow-y: auto;
        flex: 1;
      }

      /* Tabs */
      .tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: var(--spacing-lg);
      }

      .tab-btn {
        padding: var(--spacing-md) var(--spacing-lg);
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-weight: 500;
        position: relative;
        transition: color 0.2s;
      }

      .tab-btn.active {
        color: var(--primary-color);
      }

      .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--primary-color);
      }

      .tab-btn:hover {
        color: var(--primary-color);
      }

      /* Requests List */
      .requests-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .request-card {
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-md);
        box-shadow: var(--shadow-sm);
        transition: box-shadow 0.2s;
      }

      .request-card:hover {
        box-shadow: var(--shadow-md);
      }

      .request-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
      }

      .request-id {
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      .request-status {
        font-size: 0.875rem;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 12px;
      }

      .request-status.pending {
        background-color: rgba(255, 209, 102, 0.2);
        color: #e6a700;
      }

      .request-status.approved {
        background-color: rgba(6, 214, 160, 0.2);
        color: #05a97e;
      }

      .request-status.rejected {
        background-color: rgba(239, 71, 111, 0.2);
        color: #d63964;
      }

      .request-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
      }

      .request-detail {
        display: flex;
        flex-direction: column;
      }

      .detail-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 2px;
      }

      .detail-value {
        font-weight: 500;
      }

      .request-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
      }

      .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
      }

      .btn-secondary {
        background-color: var(--border-color);
        color: var(--text-primary);
      }

      .btn-secondary:hover {
        background-color: #d1d5db;
      }

      .btn-approve {
        background-color: var(--success-color);
        color: white;
      }

      .btn-approve:hover {
        background-color: #059d77;
      }

      .btn-reject {
        background-color: var(--error-color);
        color: white;
      }

      .btn-reject:hover {
        background-color: #d63964;
      }

      .btn-cancel {
        background-color: var(--warning-color);
        color: #806000;
      }

      .btn-cancel:hover {
        background-color: #e6bd5c;
      }

      .filter-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-md);
      }

      .refresh-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        border-radius: 50%;
        transition: background-color 0.2s;
      }

      .refresh-btn:hover {
        background-color: rgba(67, 97, 238, 0.1);
      }

      .loading {
        text-align: center;
        padding: var(--spacing-lg);
        color: var(--text-secondary);
      }

      /* Toast notification styles */
      .toast {
        visibility: hidden;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        min-width: 250px;
        margin-left: -125px;
        background-color: var(--text-primary);
        color: white;
        text-align: center;
        border-radius: 4px;
        padding: 16px;
        z-index: 1500;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
        opacity: 0;
        transition: visibility 0s, opacity 0.3s linear;
      }

      .toast.show {
        visibility: visible;
        opacity: 1;
      }

      .toast.success {
        background-color: var(--success-color);
      }

      .toast.error {
        background-color: var(--error-color);
      }

      .toast.warning {
        background-color: var(--warning-color);
        color: #806000;
      }

      .toast.info {
        background-color: var(--primary-color);
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Responsive styles */
      @media (max-width: 768px) {
        .swap-requests-modal .modal-content {
          width: 95%;
          margin: 2% auto;
        }
        
        .request-details {
          grid-template-columns: 1fr;
        }
        
        .tabs {
          overflow-x: auto;
          white-space: nowrap;
        }
        
        .tab-btn {
          padding: var(--spacing-sm) var(--spacing-md);
        }
      }

      .swap-detail-value {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }
      
      .duty-info-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px;
        background-color: #f8fafc;
        border-radius: 6px;
      }
      
      .duty-info-row {
        display: flex;
        padding: 4px 0;
        border-bottom: 1px solid #e2e8f0;
        line-height: 1.3;
      }
      
      .duty-info-row strong {
        min-width: 80px;
        color: #475569;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <div class="logo-icon"><span class="material-icons" aria-hidden="true">schedule</span></div>
          <div class="header-text">
            <h1>Invigilator Duty Management</h1>
            <div class="header-subtitle">Easily search and manage examination invigilation schedules</div>
          </div>
        </div>
        
        <div class="search-container">
          <form onsubmit="searchDuties(); return false;" class="search-wrapper">
            <label for="searchInput" class="search-icon">
              <span class="material-icons" aria-hidden="true">search</span>
              <span class="sr-only">Search</span>
            </label>
            <input type="search" id="searchInput" class="search-box" placeholder="Search by ID, or Name" required autocomplete="off" autocapitalize="off">
            <button type="submit" class="search-button" id="searchButton">
              Search
            </button>
          </form>
          <button type="button" class="reset-button" id="resetButton" onclick="resetSearch()">
            <span class="material-icons">refresh</span>
            Reset
          </button>
        </div>
      </div>
    </header>
    
    <div class="content">
      <div class="feature-buttons">
        <button class="feature-button" id="printButton" onclick="printDutyChart()">
          <span class="material-icons">print</span>
          Print
        </button>
        <button class="feature-button" id="notificationButton">
          <span class="material-icons">notifications</span>
          Notifications
          <label class="notification-toggle">
            <input type="checkbox" id="notificationToggle">
            <span class="toggle-slider"></span>
          </label>
        </button>
        <!-- Admin Panel button removed -->
        <!-- Duty Requests button removed -->
      </div>
      
      <div id="employeeInfo" class="employee-info" style="display: none;">
        <h2 class="section-title">
          <span class="title-icon material-icons" aria-hidden="true">account_circle</span>
          Employee Details
        </h2>
        <div class="employee-details">
          <div class="employee-detail-item">
            <div class="detail-icon">
              <span class="material-icons" aria-hidden="true">person</span>
            </div>
            <div class="detail-content">
              <div class="detail-label">NAME</div>
              <div class="detail-value" id="employeeName"></div>
            </div>
          </div>
          <div class="employee-detail-item">
            <div class="detail-icon">
              <span class="material-icons" aria-hidden="true">work</span>
            </div>
            <div class="detail-content">
              <div class="detail-label">DESIGNATION</div>
              <div class="detail-value" id="employeeDesignation"></div>
            </div>
          </div>
          <div class="employee-detail-item">
            <div class="detail-icon">
              <span class="material-icons" aria-hidden="true">email</span>
            </div>
            <div class="detail-content">
              <div class="detail-label">EMAIL</div>
              <div class="detail-value" id="employeeEmail"></div>
            </div>
          </div>
          <div class="employee-detail-item">
            <div class="detail-icon">
              <span class="material-icons" aria-hidden="true">phone</span>
            </div>
            <div class="detail-content">
              <div class="detail-label">CELL PHONE</div>
              <div class="detail-value" id="employeePhone"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="results" class="card" style="display: none;">
        <h2 class="section-title">
          <span class="title-icon material-icons" aria-hidden="true">event_note</span>
          Invigilator Duty Chart
        </h2>
        <div id="resultsContent"></div>
      </div>
    </div>
    
    <script>
      // Use passive event listeners where possible
      const eventOpts = {passive: true};
      
      // Initialize on DOMContentLoaded
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        
        // Add event listener for Enter key
        searchInput.addEventListener('keypress', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            searchDuties();
          }
        }, eventOpts);
        
        // Set focus on the search input when the page loads
        searchInput.focus();
        
        // Add touch detection
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
          document.body.classList.add('touch-device');
        }
        
        // Add resize listener with throttling
        let resizeTimer;
        window.addEventListener('resize', function() {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(addScrollIndicators, 100);
        }, eventOpts);
        
        // Improved orientation change handling
        window.addEventListener('orientationchange', function() {
          setTimeout(addScrollIndicators, 200); // Slightly longer delay for orientation changes
        }, eventOpts);
        
        // Prevent double-tap zoom on iOS
        document.addEventListener('touchend', function(event) {
          if (event.target.tagName === 'BUTTON' || event.target.tagName === 'INPUT') {
            event.preventDefault();
          }
        }, {passive: false});
        
        // Handle viewport height issues on mobile browsers
        function setVH() {
          let vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setVH();
        window.addEventListener('resize', setVH);
        
        // Initialize notification features
        initializeNotifications();
        
        // Hide feature buttons initially, show them after search
        document.querySelector('.feature-buttons').style.display = 'none';
        
        // Setup swap modal event listeners
        const closeSwapModalBtn = document.getElementById('closeSwapModal');
        const cancelSwapRequestBtn = document.getElementById('cancelSwapRequest');
        const swapRequestForm = document.getElementById('swapRequestForm');
        const swapModal = document.getElementById('swapModal');
        
        if (closeSwapModalBtn) {
          closeSwapModalBtn.addEventListener('click', closeSwapModal);
        }
        
        if (cancelSwapRequestBtn) {
          cancelSwapRequestBtn.addEventListener('click', closeSwapModal);
        }
        
        if (swapRequestForm) {
          swapRequestForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitSwapRequest();
          });
        }
        
        if (swapModal) {
          swapModal.addEventListener('click', function(e) {
            if (e.target === this) {
              closeSwapModal();
            }
          });
        }
        
        // Remove duty request button initialization
        // setupDutyRequestsButton();
      });
      
      // Initialize notification features
      function initializeNotifications() {
        const notificationButton = document.getElementById('notificationButton');
        const notificationToggle = document.getElementById('notificationToggle');
        
        // Set initial toggle state based on saved preference
        notificationToggle.checked = getNotificationPreference();
        
        // Add click event for notification button
        notificationButton.addEventListener('click', function(event) {
          // Prevent clicking the button from toggling the checkbox (we handle it manually)
          if (event.target !== notificationToggle) {
            event.preventDefault();
            
            // If toggle is currently off and permissions not granted, request permission
            if (!notificationToggle.checked) {
              if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                  // Permission already granted, toggle on
                  notificationToggle.checked = true;
                  saveNotificationPreference(true);
                  showToast('Notifications enabled!');
                  // Check for duties immediately
                  setTimeout(checkUpcomingDuties, 500);
                } else if (Notification.permission !== 'denied') {
                  // Request permission
                  requestNotificationPermission();
                } else {
                  // Permission previously denied
                  showToast('Please enable notifications in your browser settings');
                }
              } else {
                showToast('Your browser does not support notifications');
              }
            } else {
              // Toggle off
              notificationToggle.checked = false;
              saveNotificationPreference(false);
              showToast('Notifications disabled');
            }
          }
        });
        
        // Handle checkbox state changes
        notificationToggle.addEventListener('change', function() {
          if (this.checked) {
            if (Notification.permission === 'granted') {
              saveNotificationPreference(true);
              showToast('Notifications enabled!');
              // Check for duties immediately
              setTimeout(checkUpcomingDuties, 500);
            } else if (Notification.permission !== 'denied') {
              requestNotificationPermission();
            } else {
              this.checked = false;
              showToast('Please enable notifications in your browser settings');
            }
          } else {
            saveNotificationPreference(false);
            showToast('Notifications disabled');
          }
        });
        
        // Check more frequently for better responsiveness
        // Set notification check interval - check every 15 minutes
        setInterval(checkUpcomingDuties, 900000);
        
        // Initial check for upcoming duties
        if (getNotificationPreference()) {
          setTimeout(checkUpcomingDuties, 2000);
        }
        
        // Initial check for swap requests
        setTimeout(checkSwapRequests, 3000);
      }
      
      function addScrollIndicators() {
        const results = document.getElementById('results');
        if (results && results.querySelector('.duty-table')) {
          const tableContainer = results.querySelector('.table-responsive');
          const swipeIndicator = results.querySelector('.swipe-indicator');
          
          if (tableContainer && swipeIndicator) {
            const swipeText = swipeIndicator.querySelector('.swipe-text');
            
            if (tableContainer.scrollWidth > tableContainer.clientWidth) {
              // Show swipe text when table is scrollable
              if (swipeText) swipeText.style.display = 'flex';
              results.classList.add('scrollable');
            } else {
              // Hide swipe text when not scrollable, but keep credits visible
              if (swipeText) swipeText.style.display = 'none';
              results.classList.remove('scrollable');
            }
          }
        }
      }
      
      function searchDuties(forceRefresh) {
        const searchTerm = document.getElementById('searchInput').value.trim();
        if (!searchTerm) {
          showToast('Please enter an employee ID, name, or email to search');
          return;
        }
        
        document.getElementById('searchButton').innerHTML = '<span class="search-loading"><span class="loader"></span> Searching...</span>';
        document.getElementById('searchButton').disabled = true;
        
        document.getElementById('results').style.display = 'block';
        
        // Show a different message when force refreshing
        if (forceRefresh) {
          document.getElementById('resultsContent').innerHTML = 
            '<div style="text-align: center; padding: 24px;">' +
            '<div class="loader"></div>' +
            '<p style="margin-top: 12px; font-size: 14px;">Refreshing data from server...</p>' +
            '<p style="font-size: 13px; opacity: 0.8;">Ensuring latest duty information is displayed</p>' +
            '</div>';
          
          // Clear any cached data for this employee before searching
          clearCachedDataForEmployee(searchTerm);
          
          console.log("Force refreshing data for: " + searchTerm);
        } else {
          document.getElementById('resultsContent').innerHTML = 
            '<div style="text-align: center; padding: 24px;">' +
            '<div class="loader"></div>' +
            '<p style="margin-top: 12px; font-size: 14px;">Searching duties...</p>' +
            '</div>';
        }
        
        // Check if we should use cached data
        const shouldUseCache = !forceRefresh && checkCachedData(searchTerm);
        if (shouldUseCache) {
          console.log("Using cached data for: " + searchTerm);
          // Continue with the search to update UI immediately, but also refresh in background
          const cachedData = JSON.parse(localStorage.getItem('cachedDuties_' + searchTerm));
          if (cachedData) {
            setTimeout(function() {
              document.getElementById('searchButton').innerHTML = 'Search';
              document.getElementById('searchButton').disabled = false;
              displayResults(cachedData);
              
              // Refresh in the background for next time
              refreshDataInBackground(searchTerm);
            }, 300);
            return;
          }
        }
        
        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById('searchButton').innerHTML = 'Search';
            document.getElementById('searchButton').disabled = false;
            
            // Cache successful response
            if (response && response.success) {
              cacheSearchResults(searchTerm, response);
            }
            
            displayResults(response);
            
            // Refresh swap request data after search is complete
            refreshDataAfterSearch();
          })
          .withFailureHandler(function(error) {
            document.getElementById('searchButton').innerHTML = 'Search';
            document.getElementById('searchButton').disabled = false;
            showError(error.message || error.toString());
          })
          .searchInvigilatorDuties({ 
            searchTerm: searchTerm,
            forceRefresh: !!forceRefresh // Pass forceRefresh flag to backend
          });
      }
      
      // Helper function to check if we have valid cached data
      function checkCachedData(searchTerm) {
        const cacheKey = 'cachedDuties_' + searchTerm;
        const cachedDataString = localStorage.getItem(cacheKey);
        if (!cachedDataString) return false;
        
        try {
          const cachedData = JSON.parse(cachedDataString);
          if (!cachedData || !cachedData.timestamp) return false;
          
          // Check if cached data is still fresh (less than 10 minutes old)
          const MAX_CACHE_AGE = 10 * 60 * 1000; // 10 minutes in milliseconds
          const now = new Date().getTime();
          
          return (now - cachedData.timestamp) < MAX_CACHE_AGE;
        } catch (e) {
          console.error("Error parsing cached data:", e);
          return false;
        }
      }
      
      // Helper function to cache search results with timestamp
      function cacheSearchResults(searchTerm, response) {
        if (!response || !response.success) return;
        
        try {
          // Add timestamp to the response
          response.timestamp = new Date().getTime();
          
          // Store in localStorage
          localStorage.setItem('cachedDuties_' + searchTerm, JSON.stringify(response));
        } catch (e) {
          console.error("Error caching search results:", e);
        }
      }
      
      // Helper function to refresh data in background
      function refreshDataInBackground(searchTerm) {
        setTimeout(function() {
          console.log("Background refreshing data for: " + searchTerm);
          
          google.script.run
            .withSuccessHandler(function(response) {
              if (response && response.success) {
                console.log("Background refresh successful, updating cache");
                cacheSearchResults(searchTerm, response);
              }
            })
            .withFailureHandler(function(error) {
              console.error("Background refresh failed:", error);
            })
            .searchInvigilatorDuties({
              searchTerm: searchTerm,
              forceRefresh: true
            });
        }, 100);
      }
      
      // Helper function to clear cached data for a specific employee
      function clearCachedDataForEmployee(searchTerm) {
        if (!searchTerm) return;
        
        const cacheKey = 'cachedDuties_' + searchTerm;
        localStorage.removeItem(cacheKey);
      }
      
      function displayResults(response) {
        const resultsEl = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        const empInfo = document.getElementById('employeeInfo');
        
        // Show feature buttons after search
        const featureButtons = document.querySelector('.feature-buttons');
        featureButtons.style.display = 'flex';
        
        // Check if this employee has any swap requests
        setTimeout(() => {
          loadSwapRequests(searchTerm);
        }, 500);
        
        if (!response || !response.success) {
          resultsContent.innerHTML = '<div style="text-align: center; padding: 30px;"><span class="material-icons" style="font-size: 40px; color: #999; background-color: #f5f5f5; padding: 12px; border-radius: 50%; margin-bottom: 12px;">search_off</span><p style="margin-top: 8px; font-size: 15px;">No matching records found</p><p style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">Try searching with a different term</p></div>';
          if (response && response.message) {
            resultsContent.innerHTML += '<p style="text-align: center; color: var(--text-secondary); font-size: 12px; margin-top: 12px;">Error details: ' + response.message + '</p>';
          }
          empInfo.style.display = 'none';
          return;
        }
        
        // Display employee info
        empInfo.style.display = 'block';
        empInfo.classList.add('appear');
        
        const employee = response.employee;
        
        // Update detail fields - batch DOM updates
        document.getElementById('employeeName').textContent = employee.name || '-';
        document.getElementById('employeeDesignation').textContent = employee.designation || '-';
        document.getElementById('employeeEmail').textContent = employee.email || '-';
        document.getElementById('employeePhone').textContent = employee.phone || '-';
        
        // Generate table HTML
        const seasonTotal = response.seasonTotal || 0;
        const isMobile = window.innerWidth < 768;
        const isVerySmall = window.innerWidth < 360;
        let tableRows = '';
        
        // Save upcoming duties to localStorage for notifications
        if (response.duties && response.duties.length > 0) {
          // Filter duties that are today or in the future
          const today = new Date();
          const todayStr = formatDateForComparison(today);
          
          // Format dates to DD-MM-YYYY for comparison
          const upcomingDuties = response.duties
            .filter(duty => {
              if (!duty.date) return false;
              
              // Parse date string in dd-MMM-yyyy format
              const dateParts = duty.date.split('-');
              if (dateParts.length !== 3) return false;
              
              // Convert month abbreviation to month number (0-11)
              const monthNamesShort = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
              const day = parseInt(dateParts[0]);
              const month = monthNamesShort.indexOf(dateParts[1].toLowerCase());
              const year = parseInt(dateParts[2]);
              
              // If month parsing failed, try as numeric
              const monthIndex = month !== -1 ? month : parseInt(dateParts[1]) - 1;
              
              // Check if duty is today or in the future
              const dutyDate = new Date(year, monthIndex, day);
              return dutyDate >= today;
            })
            .map(duty => ({
              date: duty.date,
              program: duty.program,
              slot1: duty.slot1,
              slot2: duty.slot2,
              slot3: duty.slot3,
              slot4: duty.slot4,
              location1: duty.location1,
              location2: duty.location2,
              location3: duty.location3,
              location4: duty.location4
            }));
          
          // Save upcoming duties to localStorage for notifications
          localStorage.setItem('upcomingDuties', JSON.stringify(upcomingDuties));
          
          // Create table rows
          tableRows = (function() {
            if (!response.duties || response.duties.length === 0) {
              return `<tr><td colspan="13" style="text-align: center; padding: 24px;">No duty assignments found</td></tr>`;
            }
            
            // For each date, we'll now create a separate row but still combine locations
            return response.duties.map(duty => {
              // Format date nicely
              let dateDisplay = '';
              if (duty.date) {
                const dateParts = duty.date.split('-');
                if (dateParts.length === 3) {
                  dateDisplay = `${parseInt(dateParts[0])} ${dateParts[1]} ${dateParts[2]}`;
                } else {
                  dateDisplay = duty.date;
                }
              }
              
              // Format weekday
              const weekDayDisplay = duty.weekDay ? duty.weekDay.substring(0, 3) : '';
              
              // Format day of exam
              const dayOfExamDisplay = duty.dayOfExam ? 
                `<div class="day-of-exam">Day ${duty.dayOfExam}</div>` : '';
              
              // Check for current day
              const today = new Date();
              const formattedToday = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
              const isToday = duty.date === formattedToday;
              const rowClass = isToday ? 'current-day' : '';
              
              // Determine slot classes
              const slot1Class = duty.slot1 === 'x' ? 'slot-x' : 'slot-empty';
              const slot2Class = duty.slot2 === 'x' ? 'slot-x' : 'slot-empty';
              const slot3Class = duty.slot3 === 'x' ? 'slot-x' : 'slot-empty';
              const slot4Class = duty.slot4 === 'x' ? 'slot-x' : 'slot-empty';
              
              // Locations
              const loc1 = duty.location1 || '';
              const loc2 = duty.location2 || '';
              const loc3 = duty.location3 || '';
              const loc4 = duty.location4 || '';
              
              // Process unique locations - similar to TEXTJOIN in Excel
              // This ensures we don't show duplicate location values in the table
              // We need to use this approach when date and week are different but location is the same
              function getUniqueLocationDisplay(locationValue) {
                // If empty, return empty string
                if (!locationValue) return '';
                
                // Simply return the location value - no special processing
                // This will show each location as it is in the data
                return locationValue;
              }
              
              // Apply the unique location logic to each location
              const displayLoc1 = duty.slot1 === 'x' ? getUniqueLocationDisplay(loc1) : loc1;
              const displayLoc2 = duty.slot2 === 'x' ? getUniqueLocationDisplay(loc2) : loc2;
              const displayLoc3 = duty.slot3 === 'x' ? getUniqueLocationDisplay(loc3) : loc3;
              const displayLoc4 = duty.slot4 === 'x' ? getUniqueLocationDisplay(loc4) : loc4;
              
              return `<tr class="${rowClass}" data-date="${duty.date}">
                <td class="date-cell">
                  <div class="date">${dateDisplay}</div>
                  <div class="date-meta">
                    ${dayOfExamDisplay}
                  </div>
                </td>
                <td>${weekDayDisplay}</td>
                <td>${duty.program || '-'}</td>
                <td class="${slot1Class}">
                  <div class="slot-bg">${duty.slot1}</div>
                  ${duty.slot1 === 'x' ? 
                    `<button class="swap-button" onclick="openSwapModal('${duty.date}', '1', '${duty.program || ''}', '${displayLoc1}')">
                      <span class="material-icons">swap_horiz</span> Swap
                    </button>` : ''
                  }
                </td>
                <td class="location-cell">${displayLoc1 ? `<div class="location">${displayLoc1}</div>` : ''}</td>
                <td class="${slot2Class}">
                  <div class="slot-bg">${duty.slot2}</div>
                  ${duty.slot2 === 'x' ? 
                    `<button class="swap-button" onclick="openSwapModal('${duty.date}', '2', '${duty.program || ''}', '${displayLoc2}')">
                      <span class="material-icons">swap_horiz</span> Swap
                    </button>` : ''
                  }
                </td>
                <td class="location-cell">${displayLoc2 ? `<div class="location">${displayLoc2}</div>` : ''}</td>
                <td class="${slot3Class}">
                  <div class="slot-bg">${duty.slot3}</div>
                  ${duty.slot3 === 'x' ? 
                    `<button class="swap-button" onclick="openSwapModal('${duty.date}', '3', '${duty.program || ''}', '${displayLoc3}')">
                      <span class="material-icons">swap_horiz</span> Swap
                    </button>` : ''
                  }
                </td>
                <td class="location-cell">${displayLoc3 ? `<div class="location">${displayLoc3}</div>` : ''}</td>
                <td class="${slot4Class}">
                  <div class="slot-bg">${duty.slot4}</div>
                  ${duty.slot4 === 'x' ? 
                    `<button class="swap-button" onclick="openSwapModal('${duty.date}', '4', '${duty.program || ''}', '${displayLoc4}')">
                      <span class="material-icons">swap_horiz</span> Swap
                    </button>` : ''
                  }
                </td>
                <td class="location-cell">${displayLoc4 ? `<div class="location">${displayLoc4}</div>` : ''}</td>
                <td class="total-counts">${duty.dayCount}</td>
                <td class="season-total">${seasonTotal}</td>
              </tr>`;
            }).join('');
          })();
        } else {
          tableRows = `<tr><td colspan="13" style="text-align: center; padding: 24px;">No duty assignments found</td></tr>`;
        }
        
        // Build table HTML efficiently with minimal string concatenation
        const tableHTML = `
          <div class="duty-table-container">
            <div class="table-responsive">
              <table class="duty-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Week</th>
                    <th>${isMobile ? 'Program' : 'Degree Prog. Or<br>Semester or<br>School'}</th>
                    <th>${isMobile ? 'S1' : 'Slot 1<br><span style="font-size:9px;opacity:0.8">(09:00-10:30)</span>'}</th>
                    <th>Location</th>
                    <th>${isMobile ? 'S2' : 'Slot 2<br><span style="font-size:9px;opacity:0.8">(11:30-13:00)</span>'}</th>
                    <th>Location</th>
                    <th>${isMobile ? 'S3' : 'Slot 3<br><span style="font-size:9px;opacity:0.8">(15:30-17:00)</span>'}</th>
                    <th>Location</th>
                    <th>${isMobile ? 'S4' : 'Slot 4<br><span style="font-size:9px;opacity:0.8">(17:30-19:00)</span>'}</th>
                    <th>Location</th>
                    <th>${isMobile ? 'Day' : 'Day Total'}</th>
                    <th>${isMobile ? 'Total' : 'Season Total'}</th>
                  </tr>
                </thead>
                <tbody>${tableRows}</tbody>
              </table>
            </div>
            <div class="swipe-indicator">
              <div class="swipe-text">Swipe to see more <span class="material-icons">swipe_left</span></div>
              <div class="credits">
                <span class="credit-item">💡 Concept by Dr. Sahel Md Delabul Hossain</span>
                <span class="credit-divider">•</span>
                <span class="credit-item">© by Sairam</span>
              </div>
            </div>
          </div>
        `;
        
        // Update DOM once
        resultsContent.innerHTML = tableHTML;
        
        // Add scroll indicators if table overflows
        requestAnimationFrame(() => {
          addScrollIndicators();
        });
        
        // Smooth scrolling to results on mobile
        if (isMobile) {
          requestAnimationFrame(() => {
            resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        }
      }
      
      function showError(error) {
        const resultsEl = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        resultsEl.style.display = 'block';
        resultsContent.innerHTML = `
          <div style="text-align: center; padding: 30px;">
            <span class="material-icons" style="font-size: 40px; color: #f44336; background-color: rgba(244, 67, 54, 0.1); padding: 12px; border-radius: 50%; margin-bottom: 12px;">error_outline</span>
            <p style="margin-top: 8px; font-size: 15px; color: #f44336;">An error occurred</p>
            <p style="font-size: 13px; color: #f44336; opacity: 0.8; margin-top: 6px;">${error}</p>
          </div>
        `;
        document.getElementById('employeeInfo').style.display = 'none';
      }
      
      function resetSearch() {
        const searchInput = document.getElementById('searchInput');
        const resultsEl = document.getElementById('results');
        const empInfo = document.getElementById('employeeInfo');
        
        // Clear search input
        searchInput.value = '';
        
        // Hide results and employee info
        resultsEl.style.display = 'none';
        empInfo.style.display = 'none';
        
        // Hide feature buttons
        document.querySelector('.feature-buttons').style.display = 'none';
        
        // Focus on search input
        searchInput.focus();
      }
      
      // Print function with formatted date
      function printDutyChart() {
        // Format current date and time for print timestamp
        const now = new Date();
        const formattedDate = now.toLocaleDateString() + ' ' + 
                             now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Set the timestamp as a data attribute on the content div
        document.querySelector('.content').setAttribute('data-print-date', formattedDate);
        
        // Add a brief delay to ensure the attribute is set before printing
        setTimeout(() => {
          // Open print dialog
          window.print();
        }, 100);
      }
      
      // Duty Swap Functionality
      function openSwapModal(date, slot, program, location) {
        try {
          // Get the current employee ID
          const employeeID = document.getElementById('searchInput').value.trim();
          if (!employeeID) {
            showToast('Please search for an employee first');
            return;
          }
          
          // Set form values for swap request
          document.getElementById('swapRequesterID').value = employeeID;
          document.getElementById('swapDutyDate').value = date;
          document.getElementById('swapDutySlot').value = slot;
          document.getElementById('swapDutyProgram').value = program || '';
          document.getElementById('swapDutyLocation').value = location || '';
          
          // Display human-readable duty info
          const slotTimeText = getSlotTimeText(slot);
          const formattedDate = formatDisplayDate(date);
          document.getElementById('swapDutyInfo').innerHTML = `
            <div class="duty-info-grid">
              <div class="duty-info-row"><strong>Date:</strong> ${formattedDate}</div>
              <div class="duty-info-row"><strong>Slot:</strong> ${slotTimeText}</div>
              <div class="duty-info-row"><strong>Program:</strong> ${program || 'N/A'}</div>
              <div class="duty-info-row"><strong>Location:</strong> ${location || 'N/A'}</div>
            </div>
          `;
          
          // Clear fields that should be entered by user
          document.getElementById('swapTargetEmployee').value = '';
          document.getElementById('swapReason').value = '';
          document.getElementById('swapNotes').value = '';
          
          // Show the modal
          const modal = document.getElementById('swapModal');
          modal.classList.add('active');
          
          // Focus the first input field
          setTimeout(() => {
            document.getElementById('swapTargetEmployee').focus();
          }, 100);
          
        } catch (error) {
          console.error('Error opening swap modal:', error);
          showToast('Could not open swap request form', 'error');
        }
      }

      function closeSwapModal() {
        try {
          // Hide the modal
          const modal = document.getElementById('swapModal');
          modal.classList.remove('active');
          
          // Clear form data for security
          setTimeout(() => {
            document.getElementById('swapRequesterID').value = '';
            document.getElementById('swapDate').value = '';
            document.getElementById('swapSlot').value = '';
            document.getElementById('swapProgram').value = '';
            document.getElementById('swapLocation').value = '';
            document.getElementById('swapTargetEmployee').value = '';
            document.getElementById('swapReason').value = '';
            document.getElementById('swapNotes').value = '';
          }, 300);
        } catch (error) {
          console.error('Error closing swap modal:', error);
        }
      }
      
      function loadSwapRequests(employeeID, updateOnly = false) {
        if (!employeeID) return;
        
        const requestsList = document.getElementById('swapRequestsList');
        requestsList.innerHTML = '<div class="loading-indicator"><div class="loader"></div><div>Loading swap requests...</div></div>';
        
        // If not just updating data, show the container
        if (!updateOnly) {
          document.getElementById('swapRequestsContainer').style.display = 'block';
        }
        
        // Try using the direct sheet access first
        google.script.run
          .withSuccessHandler(function(response) {
            // Update UI with the response
            handleSwapRequestsResponse(response, requestsList, employeeID);
          })
          .withFailureHandler(function(error) {
            console.error("Error with tryGetSwapRequestsFromSheet:", error);
            
            // Fall back to the regular getSwapRequests function
            google.script.run
              .withSuccessHandler(function(response) {
                handleSwapRequestsResponse(response, requestsList, employeeID);
              })
              .withFailureHandler(function(error) {
                requestsList.innerHTML = `
                  <div class="swap-requests-empty">
                    <div class="swap-requests-empty-icon">
                      <span class="material-icons">error_outline</span>
                    </div>
                    <div class="swap-requests-empty-text">
                      Could not load swap requests.<br>
                      Please try again later.
                    </div>
                  </div>
                `;
                console.error("Error loading swap requests:", error);
                
                // Clear the badge on error
                updateSwapRequestsBadge(0);
              })
              .getSwapRequests(employeeID);
          })
          .handleTryLoadFromNamedSheet('SwapRequests');
      }

      // Helper function to handle swap requests response
      function handleSwapRequestsResponse(response, requestsList, employeeID) {
        let requestCount = 0;
        let pendingRequestCount = 0;
        
        if (response.success && response.requests && response.requests.length > 0) {
          let requestsHTML = '';
          requestCount = response.requests.length;
          
          response.requests.forEach(function(request) {
            // Only show requests for this employee
            if (request.RequesterID && request.RequesterID.toString() !== employeeID.toString()) {
              return; // Skip requests not belonging to this employee
            }
            
            // Determine status display - check both lowercase and uppercase status fields
            const status = (request.Status || request.status || 'pending').toString().toLowerCase();
            let statusLabel = 'Pending';
            
            if (status === 'approved') {
              statusLabel = 'Approved';
            } else if (status === 'rejected') {
              statusLabel = 'Rejected';
            } else if (status === 'cancelled') {
              statusLabel = 'Cancelled';
            } else {
              // Count pending requests
              pendingRequestCount++;
            }
            
            // Use either the direct field or uppercase field name based on what's available
            const requestDate = request.Date || request.date || '';
            const requestSlot = request.Slot || request.slot || '';
            const requestProgram = request.Program || request.program || 'N/A';
            const requestNotes = request.Notes || request.notes || '';
            const requestId = request.RequestID || request.id || '0';
            const targetEmployee = request.TargetEmployeeID || request.targetEmployee || 'N/A';
            const reasonType = request.ReasonType || request.reasonType || 'N/A';
            
            const formattedDate = formatDisplayDate(requestDate);
            const slotText = getSlotTimeText(requestSlot);
            
            requestsHTML += `
              <div class="swap-request-card ${status}">
                <div class="swap-request-header">
                  <div>
                    <div class="swap-status swap-status-${status}">${statusLabel}</div>
                  </div>
                  <div class="swap-request-date">${formattedDate}</div>
                </div>
                <div class="swap-request-details">
                  <div class="swap-request-detail">
                    <span class="swap-request-label">Duty:</span>
                    <span class="swap-request-value">${slotText} - ${requestProgram}</span>
                  </div>
                  <div class="swap-request-detail">
                    <span class="swap-request-label">Swap With:</span>
                    <span class="swap-request-value">${targetEmployee}</span>
                  </div>
                  <div class="swap-request-detail">
                    <span class="swap-request-label">Reason:</span>
                    <span class="swap-request-value">${reasonType}</span>
                  </div>
                  ${requestNotes ? `
                    <div class="swap-request-detail">
                      <span class="swap-request-label">Notes:</span>
                      <span class="swap-request-value">${requestNotes}</span>
                    </div>
                  ` : ''}
                </div>
                ${status === 'pending' ? `
                  <div class="swap-request-actions">
                    <button class="swap-request-button swap-request-button-cancel" 
                            onclick="cancelSwapRequest('${requestId}')">
                      Cancel Request
                    </button>
                  </div>
                ` : ''}
              </div>
            `;
          });
          
          requestsList.innerHTML = requestsHTML;
          
          // Update badge if there are pending requests
          updateSwapRequestsBadge(pendingRequestCount);
        } else {
          // Show empty state
          requestsList.innerHTML = `
            <div class="swap-requests-empty">
              <div class="swap-requests-empty-icon">
                <span class="material-icons">swap_horiz</span>
              </div>
              <div class="swap-requests-empty-text">
                You have no active swap requests.<br>
                Use the "Request Swap" button on a duty to create one.
              </div>
            </div>
          `;
          
          // Clear the badge
          updateSwapRequestsBadge(0);
        }
      }
      
      // Function to update the badge count
      function updateSwapRequestsBadge(count) {
        const swapButton = document.getElementById('swapRequestsButton');
        
        // Remove existing badge if any
        const existingBadge = swapButton.querySelector('.swap-requests-badge');
        if (existingBadge) {
          existingBadge.remove();
        }
        
        // Add badge if count > 0
        if (count > 0) {
          const badge = document.createElement('div');
          badge.className = 'swap-requests-badge';
          badge.textContent = count > 9 ? '9+' : count;
          swapButton.appendChild(badge);
        }
      }
      
      function checkSwapRequests() {
        const searchInput = document.getElementById('searchInput');
        const employeeID = searchInput.value.trim();
        
        if (employeeID) {
          loadSwapRequests(employeeID);
        }
      }
      
      function cancelSwapRequest(requestId) {
        if (!requestId) return;
        
        if (confirm("Are you sure you want to cancel this swap request?")) {
          showToast("Cancelling swap request...");
          
          google.script.run
            .withSuccessHandler(function(response) {
              if (response.success) {
                showToast("Swap request cancelled successfully");
                // Refresh the swap requests list
                const searchInput = document.getElementById('searchInput');
                loadSwapRequests(searchInput.value);
              } else {
                showToast("Failed to cancel swap request: " + (response.message || "Unknown error"));
              }
            })
            .withFailureHandler(function(error) {
              showToast("Error cancelling swap request");
              console.error("Error cancelling swap request:", error);
            })
            .cancelSwapRequest(requestId);
        }
      }
      
      function getSlotTimeText(slotNumber) {
        switch (slotNumber) {
          case '1': return 'Slot 1 (09:00-10:30)';
          case '2': return 'Slot 2 (11:30-13:00)';
          case '3': return 'Slot 3 (15:30-17:00)';
          case '4': return 'Slot 4 (17:30-19:00)';
          default: return 'Unknown Slot';
        }
      }
      
      function formatDisplayDate(dateStr) {
        if (!dateStr) return '-';
        
        const dateParts = dateStr.split('-');
        if (dateParts.length !== 3) return dateStr;
        
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        // Check format - if middle part is already a month abbreviation or a numeric month
        const day = dateParts[0];
        let month = dateParts[1];
        
        // If month is numeric, convert to abbreviation
        if (!isNaN(parseInt(month, 10))) {
          const monthIndex = parseInt(month, 10) - 1;
          if (monthIndex >= 0 && monthIndex < 12) {
            month = months[monthIndex];
          }
        } else {
          // Ensure consistent capitalization for month abbreviation
          month = month.charAt(0).toUpperCase() + month.slice(1).toLowerCase();
        }
        
        const year = dateParts[2];
        
        return `${day} ${month} ${year}`;
      }
      
      function submitSwapRequest() {
        try {
          // Get all form values
          const requesterID = document.getElementById('swapRequesterID').value;
          const date = document.getElementById('swapDutyDate').value;
          const slot = document.getElementById('swapDutySlot').value;
          const program = document.getElementById('swapDutyProgram').value;
          const location = document.getElementById('swapDutyLocation').value;
          const targetEmployee = document.getElementById('swapTargetEmployee').value.trim();
          const reasonType = document.getElementById('swapReason').value;
          const notes = document.getElementById('swapNotes').value;
          
          // Basic validation
          if (!requesterID || !date || !slot || !targetEmployee || !reasonType) {
            showToast('Please fill in all required fields', 'error');
            return;
          }
          
          // Validate target employee format
          if (targetEmployee === requesterID) {
            showToast('You cannot swap with yourself', 'error');
            return;
          }
          
          // Show loading state
          document.getElementById('submitSwapRequest').disabled = true;
          document.getElementById('submitSwapRequest').innerHTML = '<span class="material-icons rotating">refresh</span> Processing...';
          
          // Create data object for the server - arranged in the order expected by the spreadsheet
          const requestData = {
            requesterID: requesterID,
            targetEmployee: targetEmployee,
            date: date,
            slot: slot,
            program: program,
            location: location,
            reasonType: reasonType,
            notes: notes
          };
          
          // Call server-side function to submit the request
          google.script.run
            .withSuccessHandler(function(response) {
              document.getElementById('submitSwapRequest').disabled = false;
              document.getElementById('submitSwapRequest').innerHTML = 'Submit Request';
              
              if (response.success) {
                closeSwapModal();
                showToast('Swap request submitted successfully!', 'success');
              } else {
                showToast(response.message || 'Failed to submit swap request', 'error');
              }
            })
            .withFailureHandler(function(error) {
              document.getElementById('submitSwapRequest').disabled = false;
              document.getElementById('submitSwapRequest').innerHTML = 'Submit Request';
              showToast('Failed to submit swap request: ' + error.message, 'error');
            })
            .submitDutySwapRequest(requestData);
        } catch (error) {
          console.error('Error submitting swap request:', error);
          showToast('An error occurred while submitting your request', 'error');
          document.getElementById('submitSwapRequest').disabled = false;
          document.getElementById('submitSwapRequest').innerHTML = 'Submit Request';
        }
      }
      
      // Function to be called after successful search to ensure we have the latest data
      function refreshDataAfterSearch() {
        // Show feature buttons after search
        document.querySelector('.feature-buttons').style.display = 'flex';
        
        // Scroll to top of results
        window.scrollTo({
          top: document.getElementById('results').offsetTop - 80,
          behavior: 'smooth'
        });
      }
      
      function viewSwapRequests(skipServerCheck) {
        // Duty swap features removed
      }
      
      function populateRequestsList() {
        // Duty swap features removed
      }
      
      function updateRequestStatus(index, status) {
        // Duty swap features removed
      }
      
      function respondToRequest(index, status) {
        // Duty swap features removed  
      }
      
      function updateRequestsBadge() {
        // Duty swap features removed
      }
      
      function checkSwapRequests(forceRefresh = false) {
        const searchInput = document.getElementById('searchInput');
        const employeeID = searchInput.value.trim();
        
        if (employeeID) {
          loadSwapRequests(employeeID);
        }
      }
      
      function refreshDutyRequests(showLoadingIndicator) {
        // Duty swap features removed
      }

      function setupDutyRequestsButton() {
        // Duty swap feature removed - function disabled
        return;
      }

      // Ensure the swap features are not initialized
      document.addEventListener('DOMContentLoaded', function() {
        // Remove swap feature initialization
        // setupDutyRequestsButton();
      });

      // Make sure the function is called during initialization
      document.addEventListener('DOMContentLoaded', function() {
        // Duty swap features removed
        // setupDutyRequestsButton();
        
        // Also set up automatic periodic refresh
        setInterval(function() {
          // If user is looking at the app, refresh duty requests silently
          if (document.visibilityState === 'visible') {
            const currentUserID = document.getElementById('searchInput').value;
            if (currentUserID) {
              console.log('Performing background refresh of swap requests');
              // refreshDutyRequests(false); // Duty swap feature removed
            }
          }
        }, 5 * 60 * 1000); // Check every 5 minutes
      });

      // Setup swap requests button
      document.getElementById('swapRequestsButton').addEventListener('click', function() {
        handleSwapRequests();
      });
      
      /* Admin panel button event listener removed */
      
      /**
       * Open the swap requests modal
       */
      function openSwapRequestsModal() {
        try {
          console.log("Opening swap requests modal");
          
          // Make sure the modal element exists
          const modal = document.getElementById('swapRequestsModal');
          if (!modal) {
            showToast('Error: Swap requests modal not found in the DOM', 'error');
            console.error("Swap requests modal element not found");
            return;
          }
          
          modal.classList.add('active');
          
          // Set up event listeners only once
          setupSwapRequestsModalEventListeners();
          
          // Load the user's requests only if an employee is selected
          const employeeID = document.getElementById('searchInput').value.trim();
          
          if (employeeID) {
            // Load the user's requests by default (My Requests tab)
            loadMySwapRequests();
          } else {
            // Show a message indicating an employee needs to be searched first
            const container = document.getElementById('myRequestsList');
            if (container) {
              container.innerHTML = '<div class="empty-state">Please search for an employee first before viewing swap requests</div>';
            }
            showToast('Please search for an employee first', 'warning');
          }
        } catch (error) {
          console.error("Error opening swap requests modal:", error);
          showToast('Error opening swap requests: ' + error.toString(), 'error');
        }
      }

      /**
       * Set up all event listeners for the swap requests modal
       */
      function setupSwapRequestsModalEventListeners() {
        // Store if we've already set up listeners
        if (window.swapRequestsListenersInitialized) return;
        window.swapRequestsListenersInitialized = true;
        
        // Close modal when clicking the X
        document.getElementById('closeSwapRequestsModal').addEventListener('click', function() {
          closeSwapRequestsModal();
        });
        
        // Close modal when clicking outside
        document.getElementById('swapRequestsModal').addEventListener('click', function(event) {
          if (event.target === this) {
            closeSwapRequestsModal();
          }
        });
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            switchSwapRequestsTab(tabId, this);
          });
        });
        
        // Refresh buttons
        document.getElementById('refreshMyRequests').addEventListener('click', function() {
          loadMySwapRequests(true); // true to force refresh
        });
        
        document.getElementById('refreshPendingRequests').addEventListener('click', function() {
          loadPendingSwapRequests(true); // true to force refresh
        });
        
        // Create request form
        document.getElementById('createSwapSubmitBtn').addEventListener('click', submitNewSwapRequest);
        document.getElementById('createSwapCancelBtn').addEventListener('click', function() {
          document.getElementById('createSwapRequestForm').reset();
          // Switch back to My Requests tab
          switchSwapRequestsTab('myRequests', document.querySelector('.tab-btn[data-tab="myRequests"]'));
        });
        
        // Status filter
        document.getElementById('myRequestsStatusFilter').addEventListener('change', function() {
          loadMySwapRequests();
        });
      }

      /**
       * Close the swap requests modal
       */
      function closeSwapRequestsModal() {
        const modal = document.getElementById('swapRequestsModal');
        modal.classList.remove('active');
      }

      /**
       * Switch between tabs in the swap requests modal
       */
      function switchSwapRequestsTab(tabId, buttonElement) {
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
          btn.classList.remove('active');
        });
        buttonElement.classList.add('active');
        
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(function(tab) {
          tab.style.display = 'none';
        });
        
        // Show the selected tab
        document.getElementById(tabId + 'Tab').style.display = 'block';
        
        // Load content based on tab
        if (tabId === 'myRequests') {
          loadMySwapRequests();
        } else if (tabId === 'pendingRequests') {
          loadPendingSwapRequests();
        }
      }

      /**
       * Load the user's swap requests
       */
      function loadMySwapRequests(forceRefresh = false) {
        try {
          console.log("Loading swap requests for user");
          
          const employeeID = document.getElementById('searchInput').value.trim();
          const container = document.getElementById('myRequestsList');
          
          if (!container) {
            console.error("myRequestsList container not found");
            showToast('Error: Request list container not found', 'error');
            return;
          }
          
          if (!employeeID) {
            console.log("No employee ID found, showing prompt");
            showToast('Please search for an employee first', 'warning');
            container.innerHTML = '<div class="empty-state">Please search for an employee first before viewing swap requests</div>';
            return;
          }
          
          console.log("Loading requests for employee ID:", employeeID, "Force refresh:", forceRefresh);
          container.innerHTML = '<div class="loading">Loading your requests...</div>';
          
          const status = document.getElementById('myRequestsStatusFilter')?.value || 'all';
          console.log("Filtering by status:", status);
          
          // Prepare filters - use 'RequesterID' to match the server-side field name
          const filters = {
            RequesterID: employeeID
          };
          
          // Add status filter if not "all"
          if (status !== 'all') {
            filters.Status = status;
          }
          
          // Clear cache if force refresh requested
          if (forceRefresh) {
            console.log("Force refresh requested, clearing cache first");
            google.script.run
              .withSuccessHandler(function() {
                console.log("Cache cleared successfully");
                // After cache is cleared, fetch the requests
                fetchSwapRequests(filters, container);
              })
              .withFailureHandler(function(error) {
                console.error("Error clearing cache:", error);
                // Try to fetch anyway even if cache clearing failed
                fetchSwapRequests(filters, container);
              })
              .clearCache();
          } else {
            // No force refresh, just fetch requests
            fetchSwapRequests(filters, container);
          }
        } catch (error) {
          console.error("Exception in loadMySwapRequests:", error);
          showToast('Error: ' + error.toString(), 'error');
          if (document.getElementById('myRequestsList')) {
            document.getElementById('myRequestsList').innerHTML = '<div class="error">Error loading requests: ' + error.toString() + '</div>';
          }
        }
      }
      
      /**
       * Fetch swap requests with the given filters
       */
      function fetchSwapRequests(filters, container) {
        console.log("Sending request with filters:", JSON.stringify(filters));
        
        google.script.run
          .withSuccessHandler(function(response) {
            console.log("Received response:", response ? (response.success ? "Success" : "Failed") : "No response");
            if (response && response.success) {
              console.log("Received", response.requests ? response.requests.length : 0, "requests");
              renderSwapRequests(container, response.requests, 'my');
            } else {
              const errorMsg = response ? response.message : 'Unknown error';
              console.error("Error loading requests:", errorMsg);
              showToast('Error loading requests: ' + errorMsg, 'error');
              container.innerHTML = '<div class="error">Failed to load requests: ' + errorMsg + '</div>';
            }
          })
          .withFailureHandler(function(error) {
            console.error("Error in server call:", error);
            showToast('Error: ' + error.toString(), 'error');
            container.innerHTML = '<div class="error">Failed to load requests: ' + error.toString() + '</div>';
          })
          .getAllSwapRequests(filters);
      }

      /**
       * Load pending swap requests (for admin/approvers)
       */
      function loadPendingSwapRequests(forceRefresh = false) {
        const employeeID = document.getElementById('searchInput').value.trim();
        const container = document.getElementById('pendingRequestsList');
        
        if (!employeeID) {
          showToast('Please search for an employee first', 'warning');
          container.innerHTML = '<div class="empty-state">Please search for an employee first before viewing pending requests</div>';
          return;
        }
        
        container.innerHTML = '<div class="loading">Loading pending requests...</div>';
        
        // Prepare filters for pending requests only - use 'Status' to match the server-side field name
        const filters = {
          Status: 'Pending',  // Changed from status to Status to match server naming
          sheetName: 'SwapRequests'  // Specify the sheet name explicitly
        };
        
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              renderSwapRequests(container, response.requests, 'pending');
            } else {
              showToast('Error loading pending requests: ' + response.message, 'error');
              container.innerHTML = '<div class="error">Failed to load pending requests</div>';
            }
          })
          .withFailureHandler(function(error) {
            showToast('Error: ' + error.toString(), 'error');
            container.innerHTML = '<div class="error">Failed to load pending requests</div>';
          })
          .getAllSwapRequests(filters);
      }

      /**
       * Render swap requests in the provided container
       */
      function renderSwapRequests(container, requests, type = 'my') {
        try {
          console.log(`Rendering ${type} swap requests:`, requests ? requests.length : 0);
          
          if (!container) {
            console.error("Container element not found");
            return;
          }
          
          // Clear loading indicator
          container.innerHTML = '';
          
          // No requests to display
          if (!requests || requests.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">
                  <span class="material-icons">${type === 'my' ? 'swap_horiz' : 'pending_actions'}</span>
                </div>
                <div class="empty-state-text">
                  ${type === 'my' 
                    ? 'You have no active swap requests.<br>Use the "Create Request" tab to request a swap.' 
                    : 'There are no pending swap requests that require your approval.'}
                </div>
              </div>
            `;
            return;
          }
          
          // Create requests HTML
          let html = '';
          
          requests.forEach(request => {
            // Ensure all required fields exist
            const requestId = request.RequestID || '(Unknown)';
            const date = request.Date || '(No date)';
            const slot = request.Slot || '(No slot)';
            const program = request.Program || '(No program)';
            const location = request.Location || '(No location)';
            const status = request.Status || 'Pending';
            const notes = request.Notes || '';
            const dateCreated = request.DateCreated 
              ? (request.DateCreated instanceof Date 
                  ? Utilities.formatDate(request.DateCreated, Session.getScriptTimeZone(), "dd-MMM-yyyy HH:mm") 
                  : request.DateCreated) 
              : '(Unknown)';
            
            const statusClass = status.toLowerCase();
            
            html += `
              <div class="request-card status-${statusClass}">
                <div class="request-header">
                  <div class="request-id">#${requestId}</div>
                  <div class="request-status ${statusClass}">${status}</div>
                </div>
                <div class="request-body">
                  <div class="request-info">
                    <div class="request-date">
                      <span class="material-icons">event</span> ${date}
                    </div>
                    <div class="request-slot">
                      <span class="material-icons">schedule</span> ${slot}
                    </div>
                    <div class="request-program">
                      <span class="material-icons">school</span> ${program}
                    </div>
                    <div class="request-location">
                      <span class="material-icons">place</span> ${location}
                    </div>
                  </div>
                  ${notes ? `<div class="request-notes">${notes}</div>` : ''}
                  <div class="request-meta">
                    Created: ${dateCreated}
                  </div>
                </div>
                <div class="request-actions">
                  ${type === 'my' && status === 'Pending' 
                    ? `<button onclick="cancelSwapRequest('${requestId}')" class="action-btn cancel">
                        <span class="material-icons">cancel</span> Cancel
                       </button>` 
                    : ''}
                  ${type === 'pending' 
                    ? `<button onclick="approveSwapRequest('${requestId}')" class="action-btn approve">
                        <span class="material-icons">check_circle</span> Approve
                       </button>
                       <button onclick="rejectSwapRequest('${requestId}')" class="action-btn reject">
                        <span class="material-icons">cancel</span> Reject
                       </button>` 
                    : ''}
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
          
          // Add styles for swap requests if not already added
          addSwapRequestStyles();
          
        } catch (error) {
          console.error("Error rendering swap requests:", error);
          container.innerHTML = `<div class="error">Error rendering requests: ${error.toString()}</div>`;
        }
      }

      /**
       * Add CSS styles for swap requests
       */
      function addSwapRequestStyles() {
        // Check if styles are already added
        if (document.getElementById('swap-request-styles')) {
          return;
        }
        
        const style = document.createElement('style');
        style.id = 'swap-request-styles';
        style.textContent = `
          .requests-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px 0;
            max-height: 60vh;
            overflow-y: auto;
          }
          
          .request-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            overflow: hidden;
            border-left: 4px solid #9ca3af;
            transition: all 0.2s ease;
          }
          
          .request-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
          }
          
          .request-card.status-pending {
            border-left-color: #f59e0b;
          }
          
          .request-card.status-approved {
            border-left-color: #10b981;
          }
          
          .request-card.status-rejected {
            border-left-color: #ef4444;
          }
          
          .request-card.status-cancelled {
            border-left-color: #9ca3af;
          }
          
          .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
          }
          
          .request-id {
            font-weight: 600;
            color: #475569;
            font-size: 14px;
          }
          
          .request-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            background-color: #f3f4f6;
            color: #4b5563;
          }
          
          .request-status.pending {
            background-color: #fef3c7;
            color: #92400e;
          }
          
          .request-status.approved {
            background-color: #d1fae5;
            color: #065f46;
          }
          
          .request-status.rejected {
            background-color: #fee2e2;
            color: #b91c1c;
          }
          
          .request-status.cancelled {
            background-color: #f3f4f6;
            color: #4b5563;
          }
          
          .request-body {
            padding: 16px;
          }
          
          .request-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
          }
          
          .request-date,
          .request-slot,
          .request-program,
          .request-location {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #334155;
          }
          
          .request-date .material-icons,
          .request-slot .material-icons,
          .request-program .material-icons,
          .request-location .material-icons {
            font-size: 16px;
            color: #6366f1;
          }
          
          .request-notes {
            margin-top: 12px;
            padding: 12px;
            background-color: #f8fafc;
            border-radius: 6px;
            font-size: 14px;
            color: #475569;
            border-left: 3px solid #e2e8f0;
            margin-bottom: 12px;
          }
          
          .request-meta {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
          }
          
          .request-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid #e2e8f0;
            background-color: #f8fafc;
            justify-content: flex-end;
          }
          
          .action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
          }
          
          .action-btn.cancel {
            background-color: #f3f4f6;
            color: #4b5563;
          }
          
          .action-btn.cancel:hover {
            background-color: #e5e7eb;
            color: #1f2937;
          }
          
          .action-btn.approve {
            background-color: #d1fae5;
            color: #065f46;
          }
          
          .action-btn.approve:hover {
            background-color: #a7f3d0;
            color: #065f46;
          }
          
          .action-btn.reject {
            background-color: #fee2e2;
            color: #b91c1c;
          }
          
          .action-btn.reject:hover {
            background-color: #fecaca;
            color: #991b1b;
          }
          
          .action-btn .material-icons {
            font-size: 14px;
          }
          
          .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
            text-align: center;
            color: #64748b;
          }
          
          .empty-state-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #f1f5f9;
            margin-bottom: 16px;
          }
          
          .empty-state-icon .material-icons {
            font-size: 24px;
            color: #94a3b8;
          }
          
          .empty-state-text {
            font-size: 14px;
            line-height: 1.5;
          }
          
          .error {
            padding: 12px 16px;
            background-color: #fee2e2;
            color: #b91c1c;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
            border-left: 4px solid #ef4444;
          }
          
          .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px;
            color: #6b7280;
            font-size: 14px;
          }
          
          @media (max-width: 640px) {
            .request-info {
              grid-template-columns: 1fr;
              gap: 8px;
            }
            
            .request-actions {
              flex-direction: column;
            }
            
            .action-btn {
              width: 100%;
              justify-content: center;
            }
          }
        `;
        
        document.head.appendChild(style);
      }

      /**
       * Submit a new swap request
       */
      function submitNewSwapRequest() {
        const employeeID = document.getElementById('searchInput').value.trim();
        if (!employeeID) {
          showToast('Please search for an employee first', 'warning');
          return;
        }
        
        const form = document.getElementById('createSwapRequestForm');
        
        // Basic validation
        const date = document.getElementById('createSwapDate').value;
        const slot = document.getElementById('createSwapSlot').value;
        const targetEmployeeID = document.getElementById('createTargetEmployeeID').value.trim();
        
        if (!date || !slot || !targetEmployeeID) {
          showToast('Please fill in all required fields', 'warning');
          return;
        }
        
        // Get other form values
        const reasonType = document.getElementById('createSwapReasonType').value;
        const notes = document.getElementById('createSwapNotes').value;
        const program = document.getElementById('createSwapProgram').value;
        const location = document.getElementById('createSwapLocation').value;
        
        // Show loading indicator
        const submitButton = document.getElementById('submitSwapRequestBtn');
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';
        showToast('Processing request...', 'info');
        
        // Create request data
        const requestData = {
          requesterID: employeeID,
          targetEmployeeID: targetEmployeeID,
          date: date,
          slot: slot,
          reasonType: reasonType,
          notes: notes,
          program: program,
          location: location
        };
        
        // Submit the request
        google.script.run
          .withSuccessHandler(function(result) {
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Swap Request';
            
            if (result && result.success) {
              showToast('Swap request submitted successfully!', 'success');
              // Reset form
              form.reset();
              // Close modal
              document.getElementById('createSwapRequestModal').classList.remove('active');
              // Refresh swap requests
              loadMySwapRequests();
            } else {
              const errorMessage = result ? result.message : 'Failed to submit swap request. Please try again.';
              showToast('Error: ' + errorMessage, 'error');
            }
          })
          .withFailureHandler(function(error) {
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Swap Request';
            showToast('Error: ' + error.message, 'error');
          })
          .requestDutySwap(requestData);
      }

      /**
       * Format a date from yyyy-mm-dd to dd-mm-yyyy for the server
       */
      function formatDateForServer(dateString) {
        if (!dateString) return '';
        
        const parts = dateString.split('-');
        if (parts.length !== 3) return dateString;
        
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      }

      /**
       * Cancel a swap request
       */
      function cancelSwapRequest(requestID) {
        if (!confirm('Are you sure you want to cancel this swap request?')) {
          return;
        }
        
        showToast('Cancelling request...', 'info');
        
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success) {
              showToast('Request cancelled successfully', 'success');
              loadMySwapRequests(true);
            } else {
              showToast('Failed to cancel request: ' + (response.message || 'Unknown error'), 'error');
            }
          })
          .withFailureHandler(function(error) {
            showToast('Error: ' + error.toString(), 'error');
          })
          .cancelDutySwapRequest(requestID);
      }

      /**
       * Approve a swap request (admin function)
       */
      function approveSwapRequest(requestID) {
        if (!confirm('Are you sure you want to approve this swap request?')) {
          return;
        }
        
        showToast('Processing approval...', 'info');
        
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success) {
              showToast('Request approved successfully', 'success');
              loadPendingSwapRequests(true);
            } else {
              showToast('Failed to approve request: ' + (response.message || 'Unknown error'), 'error');
            }
          })
          .withFailureHandler(function(error) {
            showToast('Error: ' + error.toString(), 'error');
          })
          .adminApproveDutySwapRequest(requestID);
      }

      /**
       * Reject a swap request (admin function)
       */
      function rejectSwapRequest(requestID) {
        if (!confirm('Are you sure you want to reject this swap request?')) {
          return;
        }
        
        showToast('Processing rejection...', 'info');
        
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success) {
              showToast('Request rejected successfully', 'success');
              loadPendingSwapRequests(true);
            } else {
              showToast('Failed to reject request: ' + (response.message || 'Unknown error'), 'error');
            }
          })
          .withFailureHandler(function(error) {
            showToast('Error: ' + error.toString(), 'error');
          })
          .adminRejectDutySwapRequest(requestID);
      }
      
      // Add event listener for the Create Swap Request button
      document.getElementById('createSwapRequestButton').addEventListener('click', function() {
        // Show the swap modal with empty values
        const employeeID = document.getElementById('searchInput').value.trim();
        if (!employeeID) {
          showToast('Please search for an employee first', 'error');
          return;
        }
        
        // Get today's date in the format DD-MM-YYYY
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const todayFormatted = `${day}-${month}-${year}`;
        
        // Open the swap modal with default values
        openSwapModal(todayFormatted, '1', '', '');
      });

      /**
       * Handle swap requests button click
       */
      function handleSwapRequests() {
        try {
          console.log("Opening swap requests modal");
          
          // Make sure the modal element exists
          const modal = document.getElementById('swapRequestsModal');
          if (!modal) {
            showToast('Error: Swap requests modal not found in the DOM', 'error');
            console.error("Swap requests modal element not found");
            return;
          }
          
          modal.classList.add('active');
          
          // Set up event listeners only once
          setupSwapRequestsModalEventListeners();
          
          // Default to My Requests tab
          try {
            const myRequestsTabBtn = document.querySelector('.tab-btn[data-tab="myRequests"]');
            if (myRequestsTabBtn) {
              switchSwapRequestsTab('myRequests', myRequestsTabBtn);
            } else {
              console.error("My Requests tab button not found");
              // Try to load requests anyway
              loadMySwapRequests();
            }
          } catch (tabError) {
            console.error("Error switching to My Requests tab:", tabError);
          }
        } catch (error) {
          console.error("Error opening swap requests modal:", error);
          showToast('Error opening swap requests: ' + error.toString(), 'error');
        }
      }

      /**
       * Switch between tabs in the swap requests modal
       * @param {string} tabName - The tab to switch to ('my' or 'pending')
       */
      function switchSwapRequestTab(tabName) {
        try {
          console.log(`Switching to ${tabName} tab`);
          
          // Get all tab buttons and content sections
          const tabButtons = document.querySelectorAll('.swap-tab-btn');
          const tabContents = document.querySelectorAll('.swap-tab-content');
          
          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Add active class to the selected tab button and content
          const selectedButton = document.querySelector(`.swap-tab-btn[data-tab="${tabName}"]`);
          const selectedContent = document.getElementById(`${tabName}RequestsTab`);
          
          if (selectedButton && selectedContent) {
            selectedButton.classList.add('active');
            selectedContent.classList.add('active');
            
            // Load the appropriate content based on the tab
            if (tabName === 'my') {
              loadMySwapRequests();
            } else if (tabName === 'pending') {
              loadPendingSwapRequests();
            }
          } else {
            console.error(`Could not find tab elements for "${tabName}"`);
          }
        } catch (error) {
          console.error(`Error switching swap request tab to ${tabName}:`, error);
          showToast(`Error switching tabs: ${error.toString()}`, 'error');
        }
      }

      function clearAllCaches() {
        try {
          CacheService.getScriptCache().removeAll(['all_swap_requests_cache', 'forceRefreshInProgress']);
          return true;
        } catch (e) {
          Logger.log("Error clearing caches: " + e.toString());
          return false;
        }
      }

      function validateInput(input) {
        if (!input) return false;
        // Add more validation as needed
        return true;
      }

      function logError(functionName, error) {
        Logger.log(`Error in ${functionName}: ${error.toString()}`);
        Logger.log(`Stack: ${error.stack}`);
      }

      function checkRateLimit() {
        var cache = CacheService.getScriptCache();
        var calls = cache.get('apiCalls') || 0;
        if (calls > MAX_CALLS_PER_MINUTE) {
          throw new Error('Rate limit exceeded');
        }
        cache.put('apiCalls', parseInt(calls) + 1, 60);
      }

      function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) && email.length < 255;
      }
    </script>
    
    <!-- Duty Swap Modal -->
    <div id="swapModal" class="swap-modal">
      <div class="swap-modal-content">
        <div class="swap-modal-header">
          <h3 class="swap-modal-title">
            <span class="material-icons">swap_horiz</span>
            Request Duty Swap
          </h3>
          <button id="closeSwapModal" class="swap-modal-close">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <div class="swap-detail-section">
          <h4 class="swap-detail-title">Duty Information</h4>
          <div id="swapDutyInfo" class="swap-detail-value"></div>
        </div>
        
        <form id="swapRequestForm" class="swap-form">
          <input type="hidden" id="swapRequesterID" name="requesterID">
          <input type="hidden" id="swapDutyDate" name="date">
          <input type="hidden" id="swapDutySlot" name="slot">
          <input type="hidden" id="swapDutyLocation" name="location">
          <input type="hidden" id="swapDutyProgram" name="program">
          
          <div class="form-group">
            <label for="swapTargetEmployee" class="form-label">Swap With (Employee ID)</label>
            <input type="text" id="swapTargetEmployee" class="form-input" placeholder="Enter the exact Employee ID number" required>
            <p class="form-help">For successful matching, use the exact Employee ID as shown in the system. Names may not match correctly.</p>
          </div>
          
          <div class="form-group">
            <label for="swapReason" class="form-label">Reason for Swap</label>
            <select id="swapReason" class="form-select" required>
              <option value="">Select a reason</option>
              <option value="Personal Emergency">Personal Emergency</option>
              <option value="Medical">Medical</option>
              <option value="Schedule Conflict">Schedule Conflict</option>
              <option value="Academic">Academic</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="swapNotes" class="form-label">Additional Notes</label>
            <textarea id="swapNotes" class="form-textarea" placeholder="Any additional information about your request..."></textarea>
          </div>
          
          <div class="swap-form-buttons">
            <button type="button" id="cancelSwapRequest" class="swap-form-button swap-form-button-cancel">Cancel</button>
            <button type="submit" id="submitSwapRequest" class="swap-form-button swap-form-button-submit">Submit Request</button>
          </div>
        </form>
      </div>
    </div>

    <!-- We're using AdminSwapRequests.html instead of this container -->
    <!-- Duty swap feature permanently removed -->

    <!-- Toast notification container -->
    <div id="toast" class="toast">
      <span id="toastMessage"></span>
    </div>

    <!-- Swap Requests Modal -->
    <div id="swapRequestsModal" class="swap-requests-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Swap Requests</h2>
          <span class="close-modal" id="closeSwapRequestsModal">&times;</span>
        </div>
        <div class="modal-body">
          <div class="tabs">
            <button class="tab-btn active" data-tab="myRequests">My Requests</button>
            <button class="tab-btn" data-tab="createRequest">Create Request</button>
            <button class="tab-btn" data-tab="pendingRequests">Pending Approvals</button>
          </div>
          
          <div class="tab-content" id="myRequestsTab">
            <div class="filter-controls">
              <select id="myRequestsStatusFilter">
                <option value="all">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
              </select>
              <button id="refreshMyRequests" class="refresh-btn">
                <span class="material-icons">refresh</span>
              </button>
            </div>
            <div id="myRequestsList" class="requests-list">
              <!-- My requests will be loaded here -->
              <div class="loading">Loading your requests...</div>
            </div>
          </div>
          
          <div class="tab-content" id="createRequestTab" style="display: none;">
            <form id="createSwapRequestForm">
              <div class="form-group">
                <label for="createSwapDate">Date:</label>
                <input type="date" id="createSwapDate" name="createSwapDate" required>
              </div>
              <div class="form-group">
                <label for="createSwapSlot">Slot:</label>
                <select id="createSwapSlot" name="createSwapSlot" required>
                  <option value="">Select Slot</option>
                  <option value="1">Slot 1 (09:00-10:30)</option>
                  <option value="2">Slot 2 (11:30-13:00)</option>
                  <option value="3">Slot 3 (15:30-17:00)</option>
                  <option value="4">Slot 4 (17:30-19:00)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="createSwapLocation">Location:</label>
                <input type="text" id="createSwapLocation" name="createSwapLocation" placeholder="Optional">
              </div>
              <div class="form-group">
                <label for="createTargetEmployeeID">Target Employee ID:</label>
                <input type="text" id="createTargetEmployeeID" name="createTargetEmployeeID" required 
                      placeholder="Enter employee ID to swap with">
              </div>
              <div class="form-group">
                <label for="createSwapReason">Reason for Swap:</label>
                <textarea id="createSwapReason" name="createSwapReason" rows="3" 
                         placeholder="Provide a reason for requesting this swap"></textarea>
              </div>
              <div class="form-actions">
                <button type="button" id="createSwapCancelBtn" class="btn btn-secondary">Cancel</button>
                <button type="button" id="createSwapSubmitBtn" class="btn btn-primary">Submit Request</button>
              </div>
            </form>
          </div>
          
          <div class="tab-content" id="pendingRequestsTab" style="display: none;">
            <div class="filter-controls">
              <button id="refreshPendingRequests" class="refresh-btn">
                <span class="material-icons">refresh</span>
              </button>
            </div>
            <div id="pendingRequestsList" class="requests-list">
              <!-- Pending requests will be loaded here -->
              <div class="loading">Loading pending requests...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>